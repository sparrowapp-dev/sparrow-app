<script lang="ts">
  // ---- Assets
  import { floppyDiskIcon as floppyDisk } from "@sparrow/library/assets";

  // ---- Components
  import {
    HttpUrlSection,
    RequestHeaders,
    RequestNavigator,
    ResponseNavigator,
    RequestAuth,
    ResponseDefaultScreen,
    ResponseErrorScreen,
    ResponseHeaders,
    ResponseBodyNavigator,
    RequestBody,
    RequestName,
    ResponseBody,
    RestExtensionPanel,
    RequestParameters,
    ResponseStatus,
    MultipleMockResponse,
    NoMockResponseDetailsSection,
  } from "../components";
  import { Loader } from "@sparrow/library/ui";
  import { notifications } from "@sparrow/library/ui";
  import { Splitpanes, Pane } from "svelte-splitpanes";
  import { Button } from "@sparrow/library/ui";

  import MixpanelEvent from "@app/utils/mixpanel/MixpanelEvent";
  import type { CollectionDocument } from "@app/database/database";
  import {
    Events,
    RequestDataset,
    RequestDataType,
  } from "@sparrow/common/enums";
  import type { Observable } from "rxjs";
  import { SaveAsCollectionItem } from "@sparrow/workspaces/features";
  import type {
    ClearResponseType,
    CreateCollectionType,
    CreateFolderType,
    ReadCollectionType,
    ReadRequestOrFolderInCollectionType,
    ReadWorkspaceType,
    SaveAsRequestType,
    SaveRequestType,
    SendRequestType,
    UpdateAutoGeneratedHeadersType,
    UpdateHeadersType,
    UpdateParamsType,
    UpdateRequestAuthType,
    UpdateRequestBodyType,
    UpdateRequestDescriptionType,
    UpdateRequestMethodType,
    UpdateRequestNameType,
    UpdateRequestStateType,
    UpdateRequestUrlType,
  } from "@sparrow/workspaces/type";
  import {
    RequestDatasetEnum,
    RequestDataTypeEnum,
    RequestSectionEnum,
    ResponseSectionEnum,
    type KeyValue,
  } from "@sparrow/common/types/workspace";
  import {
    tabsSplitterDirection,
    isChatbotOpenInCurrTab,
  } from "../../../stores";
  import { Popover } from "@sparrow/library/ui";
  import { onDestroy, onMount } from "svelte";
  import { Carousel, Modal } from "@sparrow/library/ui";
  import RequestDoc from "../components/request-doc/RequestDoc.svelte";
  import {
    AdvanceAPI,
    CreateCollection,
    SendingApiRequest,
  } from "@sparrow/workspaces/constants";
  import { ResponseStatusCode } from "@sparrow/common/enums";

  import type { CancelRequestType } from "@workspaces/common/type/actions";
  import type { restExplorerData } from "../store/rest-explorer";
  import type { Tab } from "@sparrow/common/types/workspace/tab";
  import {
    CheckmarkCircleFilled,
    ErrorCircleFilled,
    CaretDownFilled,
    AddRegular,
  } from "@sparrow/library/icons";

  import { SparrowSecondaryIcon, SparkleFilled } from "@sparrow/common/icons";
  import { loadingState } from "../../../../../@sparrow-common/src/store";
  import { writable } from "svelte/store";
  import { AIChatInterface } from "../../chat-bot/components";
  import { ChatBot } from "../../chat-bot";
  import type { KeyValuePair } from "@sparrow/common/interfaces/request.interface";
  import { Select } from "@sparrow/library/forms";
  import { HttpStatusCodes } from "../utils";
  import { SparrowLogo } from "@sparrow/common/images";

  export let tab: Observable<Tab>;
  export let collections: Observable<CollectionDocument[]>;
  export let requestAuthHeader: Observable<KeyValue>;
  export let requestAuthParameter: Observable<KeyValue>;
  export let onUpdateRequestUrl: UpdateRequestUrlType;
  export let onSendRequest: SendRequestType;
  export let onCancelRequest: CancelRequestType;
  export let onUpdateRequestMethod: UpdateRequestMethodType;
  export let onUpdateRequestParams: UpdateParamsType;
  export let onUpdateRequestName: UpdateRequestNameType;
  export let onUpdateRequestBody: UpdateRequestBodyType;
  export let onUpdateRequestAuth: UpdateRequestAuthType;
  export let onUpdateHeaders: UpdateHeadersType;
  export let onUpdateAutoGeneratedHeaders: UpdateAutoGeneratedHeadersType;
  export let onUpdateRequestState: UpdateRequestStateType;
  export let onUpdateResponseState;
  export let onClearResponse: ClearResponseType;
  export let onSaveRequest: SaveRequestType;
  export let onUpdateRequestDescription: UpdateRequestDescriptionType;
  export let readRequestOrFolderInCollection: ReadRequestOrFolderInCollectionType;
  export let readCollection: ReadCollectionType;
  export let readWorkspace: ReadWorkspaceType;
  export let onSaveAsRequest: SaveAsRequestType;
  export let onCreateFolder: CreateFolderType;
  export let onCreateCollection: CreateCollectionType;
  export let onUpdateEnvironment;
  export let environmentVariables;
  export let isGuestUser = false;
  export let onOpenCollection;
  export let onUpdateResponseBody;
  export let onUpdateResponseHeaders;
  export let onUpdateResponseStatus;
  export let onCreateMockResponse;
  export let onHandleMockResponseState;
  export let onRenameMockResponse;
  export let onDeleteMockResponse;

  export let onGenerateAiResponse;
  export let onToggleLike;

  // export let isLoginBannerActive = false;
  export let isPopoverContainer = true;
  export let onFetchCollectionGuide: (query) => void;
  export let onUpdateCollectionGuide: (query, isActive) => void;
  export let onUpdateAiPrompt;
  export let onUpdateAiConversation;
  export let onUpdateAiModel;
  export let onGenerateDocumentation;
  export let onStopGeneratingAIResponse;

  /**
   * Role of user in active workspace
   */
  export let userRole;
  export let storeData: restExplorerData | undefined;
  export let isTourGuideOpen = false;
  export let isWebApp = false;
  export let azureBlobCDN;
  export let onSaveResponse;
  export let collectionAuth;
  export let collection;
  const loading = writable<boolean>(false);

  // Props for showing merge/diff view in RequestBody, Headers and Params
  let isAIDebugBtnEnable = false;
  let isMergeViewEnableForRequestBody = false;
  let isMergeViewEnableForParams = false;
  let isMergeViewEnableForHeaders = false;
  let isMergeViewLoading = false;
  let newModifiedContent: string | KeyValuePair[];
  let mergeViewRequestDatasetType: RequestDatasetEnum;

  // Reference to the splitpane container element
  let splitpaneContainer;
  let splitpaneContainerWidth = 0;

  // Chatbot pane size constraints in pixels (based on Figma design)
  const minPx = 343;
  const maxPx = 525;
  const defaultPx = 452;

  // Chatbot pane size constraints in percentage (calculated at runtime)
  let minSizePct = 0;
  let maxSizePct = 0;
  let defaultSizePct = 0;

  //Multiple Mockresponses
  let mockResponses = [];
  let activeMockResponseIdx = 0;
  function handleSetActiveResponseIdx(e) {
    activeMockResponseIdx = e.activeResponseIdx;
  }
  $: selectedResponse =
    $tab.property?.mockRequest?.items?.[activeMockResponseIdx];

  /**
   * Converts the pixel-based min, max, and default sizes
   * of the chatbot pane into percentages relative to the
   * current width of the splitpane container.
   *
   * Required because `svelte-splitpane` accepts sizes in percentages.
   */
  function updateSplitpaneContSizes() {
    if (!splitpaneContainer) return;

    splitpaneContainerWidth = splitpaneContainer.clientWidth;

    minSizePct = (minPx / splitpaneContainerWidth) * 100;
    maxSizePct = (maxPx / splitpaneContainerWidth) * 100;
    defaultSizePct = (defaultPx / splitpaneContainerWidth) * 100;
  }

  const closeCollectionHelpText = () => {
    onUpdateCollectionGuide({ id: "collection-guide" }, false);
    isPopoverContainer = !isPopoverContainer;
  };

  onMount(async () => {
    const event = await onFetchCollectionGuide({
      id: "collection-guide",
    });
    event?.$.subscribe((e) => {
      if (e.isActive === false) {
        isPopoverContainer = false;
      } else {
        isPopoverContainer = true;
      }
    });

    // Delay to ensure DOM is ready before measuring container width
    setTimeout(() => {
      updateSplitpaneContSizes();
      // Watch for container size changes and update pane size percentages
      const resizeObserver = new ResizeObserver(() => {
        updateSplitpaneContSizes();
      });
      resizeObserver.observe(splitpaneContainer);
      return () => resizeObserver.disconnect(); // Cleanup on component unmount
    }, 0);
  });

  export let onRenameCollection;
  export let onRenameFolder;

  let isExposeSaveAsRequest = false;
  let isLoading = true;
  let isErrorMsgOpen = false;

  $: {
    if ($tab?.property?.mockRequest?.url?.length > 0) {
      isLoading = false;
    }
  }
  $: {
    if (isTourGuideOpen) {
      isGuidePopup = true;
    }
  }
  const toggleSaveRequest = (flag: boolean): void => {
    isExposeSaveAsRequest = flag;
  };

  $: {
    loadingState.subscribe((tab) => {
      loading.set(tab.get($tab.tabId));
    });
  }
  let isGuidePopup = false;

  // Here we are closing the chatbot when user switches to vertical layout view.
  // This can be handled with a better approach, as its not user friendly way
  // that we are closing the Chatbot interface with respect to vertical layout switching
  // $: {
  //   if (!isLoading && $tabsSplitterDirection != "horizontal") {
  //     console.log("not active chatbox!!");
  //     onUpdateRequestState({
  //       isChatbotActive: false,
  //     });
  //   }
  // }
  $: if (!isGuestUser && $tab?.property?.mockRequest?.state?.isChatbotActive) {
    isChatbotOpenInCurrTab.set(true);
  }
  onDestroy(() => {
    isChatbotOpenInCurrTab.set(false);
  });

  /**
   * Enables the diff/merge view while having suggested changes by AI
   * @param newContent The new changes suggested
   * @param requestDatasetType Request Body dataset type (Raw, Binary, URL Encoded, Form Data)
   * @param contentType Request Body dataset type (JSON, HTML, JavaScript, Text, XML)
   */
  const enabledMergeViewForReqBody = async (
    newContent: string,
    requestDatasetType: RequestDatasetEnum,
    contentType: RequestDataTypeEnum,
  ) => {
    // Auto Navigation
    onUpdateRequestState({
      requestNavigation: RequestSectionEnum.REQUEST_BODY,
    });
    onUpdateRequestState({ requestBodyNavigation: requestDatasetType });
    onUpdateRequestState({ requestBodyLanguage: contentType });

    if (isMergeViewEnableForRequestBody) {
      notifications.info("Please accept the current suggested changes first.");
      return;
    }

    if (requestDatasetType === RequestDatasetEnum.RAW) {
      newModifiedContent = newContent;
    } else if (requestDatasetType === RequestDatasetEnum.URLENCODED) {
      newModifiedContent = convertJsonToKeyValPairs(JSON.parse(newContent));
    } else if (requestDatasetType === RequestDatasetEnum.FORMDATA) {
      newModifiedContent = convertJsonToKeyValPairs(JSON.parse(newContent));
    } else if (requestDatasetType === RequestDatasetEnum.BINARY) return;
    else return;

    mergeViewRequestDatasetType = requestDatasetType;
    isMergeViewEnableForRequestBody = true;
    // isMergeViewLoading = true;
  };

  /**
   * Embeds the changes suggested by AI in request data
   * @param target Where to insert the changes (Request Body or Headers or Parameters)
   * @param language Language type of suggested code changes by AI (JSON, HTML, JavaScript, Text, XML)
   * @param requestBodyType Request Body datas et type (Raw, Binary, URL Encoded, Form Data)
   * @param modifiedContent The new content suggested by AI
   */
  const handleApplyChangeOnAISuggestion = async (
    target: RequestSectionEnum,
    language: RequestDataTypeEnum,
    requestBodyType: RequestDatasetEnum,
    modifiedContent,
  ) => {
    // For testing, remove while raising PR
    // target = "Parameters";
    // target = "Headers";
    if (
      isMergeViewEnableForHeaders ||
      isMergeViewEnableForParams ||
      isMergeViewEnableForRequestBody
    ) {
      notifications.error("Please accept the current suggested changes first.");
      return;
    }

    try {
      switch (target) {
        case RequestSectionEnum.REQUEST_BODY: {
          // For testing, remove while raising PR
          // requestBodyType = "URL Encoded" as RequestDatasetEnum;
          // requestBodyType = "Form Data" as RequestDatasetEnum;

          enabledMergeViewForReqBody(
            modifiedContent,
            requestBodyType,
            language,
          );
          break;
        }
        case RequestSectionEnum.HEADERS:
        case RequestSectionEnum.PARAMETERS: {
          const newData = convertJsonToKeyValPairs(JSON.parse(modifiedContent));

          // Auto navigating to request navigator tab
          onUpdateRequestState({
            requestNavigation:
              target === RequestSectionEnum.HEADERS
                ? RequestSectionEnum.HEADERS
                : RequestSectionEnum.PARAMETERS,
          });

          if (isMergeViewEnableForHeaders || isMergeViewEnableForParams) {
            notifications.error(
              "Please accept the current suggested changes first.",
            );
            return;
          }

          await sleep(500);
          newModifiedContent = newData;
          // isMergeViewLoading = true;
          if (target === RequestSectionEnum.HEADERS)
            isMergeViewEnableForHeaders = true;
          else isMergeViewEnableForParams = true;
          break;
        }
        default:
          break;
      }
    } catch (err) {
      console.log("Error which inserting AI suggestions: ", err);
    }
  };

  /**
   * Converts an object (data A) to an array of KeyValuePair objects (data B)
   * @param {Record<string, any>} dataA - The input object to convert
   * @param {boolean} defaultChecked - Default value for the checked property if not found in input (defaults to true)
   * @returns {KeyValuePair[]} Array of objects conforming to KeyValuePair interface
   */
  const convertJsonToKeyValPairs = (
    dataA: Record<string, any>,
  ): KeyValuePair[] => {
    // Check if input is valid
    if (!dataA || typeof dataA !== "object" || Array.isArray(dataA)) {
      throw new Error("Input must be a valid object");
    }

    const defaultChecked = true; // fallback value

    // Get checked value from input if it exists
    const checkedValue =
      typeof dataA.checked === "boolean" ? dataA.checked : defaultChecked;

    // Convert object to array of KeyValuePair objects
    const dataB: KeyValuePair[] = Object.entries(dataA)
      .filter(([key]) => key !== "checked") // Skip the checked property itself
      .map(([key, value]) => {
        // Convert value to string if it's not already
        const stringValue =
          Array.isArray(value) || (typeof value === "object" && value !== null)
            ? JSON.stringify(value)
            : String(value);

        return {
          key,
          value: stringValue,
          checked: checkedValue,
        };
      });

    return dataB;
  };

  // Utility function to create a delay
  const sleep = (ms: number): Promise<void> => {
    return new Promise((resolve) => setTimeout(resolve, ms));
  };

  const handleOnClickAIDebug = async () => {
    isAIDebugBtnEnable = false;

    // adjusting the panel layout
    if ($tabsSplitterDirection != "horizontal") {
      tabsSplitterDirection.set("horizontal");
      isChatbotOpenInCurrTab.set(true);
    }

    const isResponseGenerating =
      $tab?.property?.mockRequest?.state?.isChatbotGeneratingResponse;

    if (!isResponseGenerating) {
      onUpdateAiConversation([
        ...$tab?.property?.mockRequest?.ai?.conversations,
        {
          message: "Help me debug",
          messageId: "",
          type: "Sender",
          isLiked: false,
          isDisliked: false,
          status: true,
        },
      ]);

      // The prompt in the below format is required to trigger the 4xx error debugging instructions for AI model
      const debugPrompt = `[DEBUG_4XX_ERROR_REQUEST]
        I am getting the below mentioned error when I send request. 
        Can you help me debug this error and tell me what changes I need to make in my request to solve this issue.
        Error Response (${storeData.response.status || "4xx"}): ${JSON.stringify(storeData?.response)}
        Please analyze this error and provide suggestions to fix it following your strict error debugging protocol. I need formatted suggestions that can be directly applied to my request configuration.
        [/DEBUG_4XX_ERROR_REQUEST]`;

      // ToDo: Enable scroller
      // Scroller for user prompt
      // setTimeout(() => {
      //   if (scrollList) scrollList("bottom", -1, "smooth");
      // }, 10);

      await onGenerateAiResponse(debugPrompt);

      // ToDo: Enable scroller
      // Scroller for AI response
      // setTimeout(() => {
      //   if (scrollList) scrollList("bottom", -1, "smooth");
      // }, 10);

      onUpdateRequestState({ isChatbotActive: true });
    }

    // ToDo: Register mixpanel event for "Help me debug" action
    // MixpanelEvent(Events.AI_Ext_Gen_Curl_Prompt);
  };

  /**
   * Checks whether the response status code indicates a client error (HTTP 4xx).
   * @returns {boolean} - Returns true if the status code is between 400 and 499, otherwise false.
   */
  const isClientError = () => {
    const status = storeData?.response?.status;
    const code = parseInt(status?.split(" ")[0]);
    return code >= 400 && code < 500;
  };

  $: {
    if (storeData) {
      if (isClientError()) isAIDebugBtnEnable = true;
      else isAIDebugBtnEnable = false;
    }
  }

  let selectedStatusCode = "";
</script>

{#if $tab.tabId}
  <div class="d-flex rest-explorer-layout h-100">
    <div class="w-100 d-flex flex-column h-100 p-3">
      <!-- Request Name Header -->
      <!-- 
        --
        -- Rest name header is set to display none 
        --
      -->
      <div class="d-flex justify-content-between w-100 p-3 d-none">
        <RequestName name={$tab.name} {onUpdateRequestName} />

        <div class="d-flex justify-content-between">
          <Button
            title="Save Request"
            type={"secondary"}
            loader={false}
            buttonClassProp="ms-2"
            buttonStartIcon={floppyDisk}
            onClick={async () => {
              const x = await onSaveRequest();
              if (
                x.status === "error" &&
                x.message ===
                  "request is not a part of any workspace or collection"
              ) {
                isExposeSaveAsRequest = true;
              } else if (x.status === "success") {
                notifications.success("Mock Request saved successfully.");
              }
            }}
          /> <span class="position-relative" style="width:35px;"> </span>
          <Button
            title="Share"
            type={"secondary"}
            buttonClassProp="ms-2"
            onClick={() => {}}
          />
        </div>
      </div>

      <!-- HTTP URL Section -->
      <HttpUrlSection
        class=""
        isSaveLoad={$loading}
        isSave={$tab.isSaved}
        bind:userRole
        requestUrl={$tab.property.mockRequest?.url}
        httpMethod={$tab.property.mockRequest?.method}
        isSendRequestInProgress={storeData?.isSendRequestInProgress}
        onSendButtonClicked={onSendRequest}
        onCancelButtonClicked={onCancelRequest}
        {onUpdateEnvironment}
        {environmentVariables}
        {onUpdateRequestUrl}
        {onUpdateRequestMethod}
        {toggleSaveRequest}
        {onSaveRequest}
        {isGuestUser}
      />

      <div
        bind:this={splitpaneContainer}
        style="flex:1; overflow:auto; margin-top: 12px;"
      >
        <Splitpanes class="explorer-chatbot-splitter">
          <Pane class="position-relative bg-transparent">
            <!--Disabling the Quick Help feature, will be taken up in next release-->
            {#if isPopoverContainer}
              <Popover
                onClose={closeCollectionHelpText}
                heading={`Welcome to Sparrow`}
              >
                <p class="mb-0 text-fs-12">
                  Your one-stop solution for API testing and management. Start
                  organizing your API requests into collections, utilize
                  environment variables, and streamline your development
                  process. Get started now by creating your first collection or
                  exploring our features
                  <span
                    on:click={() => {
                      isGuidePopup = true;
                    }}
                    class="link p-0 border-0"
                    style="font-size: 12px;"
                    >See how it works.
                  </span>
                </p>
              </Popover>
              <div class="pt-2"></div>
            {/if}

            {#if !isLoading}
              <Splitpanes
                class="rest-splitter w-100 h-100"
                id={"rest-splitter"}
                horizontal={$tabsSplitterDirection === "horizontal"
                  ? true
                  : false}
                dblClickSplitter={false}
                on:resize={(e) => {
                  onUpdateRequestState({
                    requestLeftSplitterWidthPercentage: e.detail[0].size,
                  });
                  onUpdateRequestState({
                    requestRightSplitterWidthPercentage: e.detail[1].size,
                  });
                }}
              >
                <Pane
                  minSize={30}
                  size={$tab.property.mockRequest?.state
                    ?.requestLeftSplitterWidthPercentage}
                  class="position-relative bg-transparent"
                >
                  <!-- Request Pane -->
                  <div
                    class="h-100 d-flex flex-column position-relative {$tabsSplitterDirection ===
                    'horizontal'
                      ? 'pb-1'
                      : 'pe-2'}"
                  >
                    <RequestNavigator
                      requestStateSection={$tab.property.mockRequest?.state
                        ?.requestNavigation}
                      {onUpdateRequestState}
                      authParameterLength={$requestAuthParameter.value ? 1 : 0}
                      authHeaderLength={$requestAuthHeader.value ? 1 : 0}
                      paramsLength={$tab.property?.mockRequest?.queryParams
                        ?.length || 0}
                      headersLength={$tab.property?.mockRequest?.headers
                        ?.length || 0}
                      autoGeneratedHeadersLength={$tab.property?.mockRequest
                        ?.autoGeneratedHeaders?.length || 0}
                    />
                    <div style="flex:1; overflow:auto;" class="p-0">
                      {#if $tab.property.mockRequest?.state?.requestNavigation === RequestSectionEnum.PARAMETERS}
                        <RequestParameters
                          isBulkEditActive={$tab?.property?.mockRequest.state
                            ?.isParameterBulkEditActive}
                          {onUpdateRequestState}
                          params={$tab.property.mockRequest.queryParams}
                          {onUpdateRequestParams}
                          authParameter={$requestAuthParameter}
                          {onUpdateEnvironment}
                          {environmentVariables}
                          bind:isMergeViewEnabled={isMergeViewEnableForParams}
                          bind:isMergeViewLoading
                          bind:newModifiedContent
                        />
                      {:else if $tab.property.mockRequest?.state?.requestNavigation === RequestSectionEnum.REQUEST_BODY}
                        <RequestBody
                          body={$tab.property.mockRequest.body}
                          method={$tab.property.mockRequest.method}
                          requestState={$tab.property.mockRequest.state}
                          {onUpdateRequestBody}
                          {onUpdateRequestState}
                          {onUpdateEnvironment}
                          {environmentVariables}
                          {isWebApp}
                          bind:isMergeViewEnabled={isMergeViewEnableForRequestBody}
                          bind:isMergeViewLoading
                          bind:newModifiedContent
                          {mergeViewRequestDatasetType}
                        />
                      {:else if $tab.property.mockRequest?.state?.requestNavigation === RequestSectionEnum.HEADERS}
                        <RequestHeaders
                          isBulkEditActive={$tab?.property?.mockRequest.state
                            ?.isHeaderBulkEditActive}
                          {onUpdateRequestState}
                          {environmentVariables}
                          {onUpdateEnvironment}
                          headers={$tab.property.mockRequest.headers}
                          autoGeneratedHeaders={$tab.property.mockRequest
                            .autoGeneratedHeaders}
                          authHeader={$requestAuthHeader}
                          onHeadersChange={onUpdateHeaders}
                          onAutoGeneratedHeadersChange={onUpdateAutoGeneratedHeaders}
                          {isWebApp}
                          bind:isMergeViewEnabled={isMergeViewEnableForHeaders}
                          bind:isMergeViewLoading
                          bind:newModifiedContent
                        />
                      {:else if $tab.property.mockRequest?.state?.requestNavigation === RequestSectionEnum.AUTHORIZATION}
                        <RequestAuth
                          requestStateAuth={$tab.property.mockRequest.state
                            .requestAuthNavigation}
                          {onUpdateRequestState}
                          auth={$tab.property.mockRequest.auth}
                          collectionAuth={$collectionAuth}
                          {onUpdateRequestAuth}
                          {onUpdateEnvironment}
                          {environmentVariables}
                          {collection}
                          {onOpenCollection}
                        />
                      {:else if $tab.property.mockRequest?.state?.requestNavigation === RequestSectionEnum.DOCUMENTATION}
                        <RequestDoc
                          isDocGenerating={$tab.property.mockRequest?.state
                            ?.isDocGenerating}
                          isDocAlreadyGenerated={$tab.property.mockRequest
                            ?.state?.isDocAlreadyGenerated}
                          {onGenerateDocumentation}
                          {onUpdateRequestDescription}
                          requestDoc={$tab.description}
                          {isGuestUser}
                        />
                      {/if}
                    </div>
                  </div>
                </Pane>
                <Pane
                  minSize={30}
                  size={$tab.property.mockRequest?.state
                    ?.requestRightSplitterWidthPercentage}
                  class="bg-transparent position-relative"
                >
                  <!-- Response Pane -->
                  <div class="d-flex h-100" style="gap: 8px;">
                    <div style="width: 25%">
                      <MultipleMockResponse
                        requestName={$tab.name}
                        requestMethod={$tab.property.mockRequest?.method}
                        mockResponses={$tab.property.mockRequest?.items || []}
                        {userRole}
                        {isWebApp}
                        {onCreateMockResponse}
                        {onHandleMockResponseState}
                        {onRenameMockResponse}
                        {onDeleteMockResponse}
                        activeResponseIdx={activeMockResponseIdx}
                        onSetActiveResponseIdx={handleSetActiveResponseIdx}
                      />
                    </div>
                    <div
                      style="width:1px; background:var(--border-ds-surface-100); height:100%; margin-left: 8px;"
                    ></div>
                    <div
                      class="d-flex flex-column h-100 {$tabsSplitterDirection ===
                      'horizontal'
                        ? 'pt-1'
                        : 'ps-2'}"
                      style="flex:1;"
                    >
                      {#if $tab.property.mockRequest?.items?.length === 0}
                        <NoMockResponseDetailsSection {onCreateMockResponse} />
                      {:else}
                        <div class="h-100 d-flex flex-column">
                          <div style="flex:1; overflow:auto;">
                            <!-- {#if storeData?.isSendRequestInProgress}
                          <ResponseDefaultScreen {isWebApp} />
                          <div
                            style="top: 0px; left: 0; right: 0; bottom: 0; z-index:3; position:absolute;"
                          >
                            <Loader loaderSize={"20px"} />
                          </div>
                        {:else if !storeData?.response.status}
                          <ResponseDefaultScreen {isWebApp} />
                        {:else if storeData?.response.status === ResponseStatusCode.ERROR}
                          <ResponseErrorScreen
                            onSendButtonClicked={onSendRequest}
                            response={storeData.response}
                            {environmentVariables}
                          />
                        {:else if storeData?.response.status} -->
                            <div
                              class="h-100 d-flex flex-column"
                              style="gap:12px"
                            >
                              <!-- <div
                            class="d-flex justify-content-between"
                            style="position:sticky; top:0; z-index:1; background-color:var(--bg-ds-surface-900)"
                          > -->
                              <div class="d-flex justify-content-between">
                                <ResponseNavigator
                                  requestStateSection={selectedResponse?.state
                                    ?.responseNavigation}
                                  {onUpdateResponseState}
                                  responseHeadersLength={selectedResponse
                                    ?.mockRequestResponse?.responseHeaders
                                    ?.length || 0}
                                  selectedResponseId={selectedResponse?.id}
                                />
                                <Select
                                  data={HttpStatusCodes}
                                  onclick={(selectedItem) => {
                                    selectedStatusCode = selectedItem;
                                    onUpdateResponseStatus(
                                      selectedItem,
                                      selectedResponse?.id,
                                    );
                                  }}
                                  titleId={selectedResponse?.mockRequestResponse
                                    ?.responseStatus}
                                  placeholderText={"Status Code"}
                                  id={"httpStatusCode"}
                                  zIndex={701}
                                  disabled={false}
                                  minBodyWidth={"180px"}
                                  minHeaderWidth={"180px"}
                                  maxHeaderWidth={"180px"}
                                  bodyTheme={"violet"}
                                  menuItem={"v2"}
                                  headerFontSize={"12px"}
                                  isDropIconFilled={true}
                                  maxBodyHeight={"196px"}
                                  variant={"secondary"}
                                  borderType={"none"}
                                  borderActiveType={"none"}
                                  borderHighlight={"hover-active"}
                                  headerHighlight={"hover-active"}
                                  headerHeight={"26px"}
                                  borderRounded={"4px"}
                                  headerSearchable={true}
                                />
                              </div>
                              <!-- </div> -->
                              <div
                                class="flex-grow-1 d-flex flex-column"
                                style="overflow:auto; min-height:0;"
                              >
                                {#if selectedResponse?.state?.responseNavigation === ResponseSectionEnum.RESPONSE}
                                  {#if selectedResponse?.state?.responseBodyLanguage !== "Image"}
                                    <ResponseBodyNavigator
                                      response={selectedResponse
                                        ?.mockRequestResponse
                                        ?.responseHeaders || []}
                                      apiState={selectedResponse?.state}
                                      path={$tab.path}
                                      responseId={selectedResponse.id}
                                      {onUpdateResponseState}
                                      {onUpdateRequestState}
                                      {onClearResponse}
                                      {onSaveResponse}
                                      {isWebApp}
                                      {isGuestUser}
                                      {userRole}
                                    />
                                  {/if}
                                  <div
                                    style="flex:1; overflow:auto; border:1px solid var(--border-ds-surface-100); border-radius: 4px;"
                                  >
                                    <ResponseBody
                                      response={selectedResponse
                                        ?.mockRequestResponse?.responseBody}
                                      apiState={selectedResponse?.state}
                                      {onUpdateResponseBody}
                                      responseId={selectedResponse.id}
                                    />
                                  </div>
                                {:else if selectedResponse?.state?.responseNavigation === ResponseSectionEnum.HEADERS}
                                  <div style="overflow:auto;">
                                    <ResponseHeaders
                                      responseHeaders={selectedResponse
                                        ?.mockRequestResponse?.responseHeaders}
                                      {onUpdateResponseHeaders}
                                      responseId={selectedResponse.id}
                                    />
                                  </div>
                                {/if}
                              </div>
                            </div>
                            <!-- {/if} -->
                          </div>
                        </div>
                      {/if}
                    </div>
                  </div>
                </Pane>
              </Splitpanes>
            {:else}
              <!-- loading state -->
              <ResponseDefaultScreen isMainScreen={true} {isWebApp} />
            {/if}
          </Pane>
          <!-- AI Chatbot Interface -->
          {#if !isGuestUser && $tab?.property?.mockRequest?.state?.isChatbotActive}
            <Pane
              class="position-relative bg-transparent"
              minSize={minSizePct}
              size={defaultSizePct}
              maxSize={maxSizePct}
            >
              <ChatBot
                {tab}
                {onUpdateAiPrompt}
                {onUpdateAiConversation}
                {onUpdateAiModel}
                {onUpdateRequestState}
                {onGenerateAiResponse}
                {onStopGeneratingAIResponse}
                {onToggleLike}
                {handleApplyChangeOnAISuggestion}
              />
            </Pane>
          {/if}
        </Splitpanes>
      </div>
    </div>
    <!--
      --
       -- Rest extension panel is set to display none 
      --
    -->
    <div class="d-none">
      <RestExtensionPanel
        state={$tab.property.mockRequest?.state}
        requestMethod={$tab.property.mockRequest?.method}
        requestUrl={$tab.property.mockRequest?.url}
        requestName={$tab.name}
        requestDescription={$tab.description}
        requestPath={$tab.path}
        collections={$collections}
        {onSaveRequest}
        {readCollection}
        {readWorkspace}
        {onSaveAsRequest}
        {onCreateFolder}
        {onCreateCollection}
        {onUpdateRequestState}
        {onUpdateRequestDescription}
        {readRequestOrFolderInCollection}
      />
    </div>
  </div>
  <Modal
    title={"Save Request"}
    type={"dark"}
    width={"55%"}
    zIndex={10000}
    isOpen={isExposeSaveAsRequest}
    handleModalState={(flag = false) => {
      isExposeSaveAsRequest = flag;
    }}
  >
    <SaveAsCollectionItem
      onClick={(flag = false) => {
        isExposeSaveAsRequest = flag;
      }}
      requestMethod={$tab.property.mockRequest?.method}
      requestUrl={$tab.property.mockRequest?.url}
      requestName={$tab.name}
      requestDescription={$tab.description}
      requestPath={$tab.path}
      collections={$collections}
      {readWorkspace}
      onSave={onSaveAsRequest}
      {onCreateFolder}
      {onCreateCollection}
      {onRenameCollection}
      {onRenameFolder}
    />
  </Modal>
{/if}

<Modal
  title={""}
  type={"dark"}
  width={"474px"}
  zIndex={10000}
  isOpen={isGuidePopup}
  handleModalState={(flag = false) => {
    isGuidePopup = flag;
    isTourGuideOpen = false;
  }}
>
  <div style="position: relative;">
    <Carousel
      handleClosePopup={(flag = false) => {
        isGuidePopup = flag;
        isTourGuideOpen = false;
      }}
      data={[
        {
          id: 1,
          heading: "Creating a Collection: Import existing or Start a new one",
          subheading: `Organize your APIs efficiently within "Collections" for streamlined API management and testing. Click the + Add Collection button in the side panel to create a collection. Choose 'Import Collection' to bring in existing API collections or create an empty Collection. `,
          gif: `${azureBlobCDN}${CreateCollection}`,
        },
        {
          id: 2,
          heading: "Sending an API Request",
          subheading:
            "In the request builder, input your API endpoint URL in the URL field. Click the 'Send' button to dispatch the request. Instantly see the server's response, which includes status codes, response time, and data.",
          gif: `${azureBlobCDN}${SendingApiRequest}`,
        },
        {
          id: 3,
          heading: "Advanced API Request with Detailed Inputs",
          subheading:
            "Enter the endpoint URL in the URL field. Utilize 'Parameters' tab for parameters, 'Body' tab to input data payloads, 'Headers' tab for custom headers, and 'Auth' tab to manage access credentials. After filling in the required fields, click 'Send' to execute the request and view the detailed server response.",
          gif: `${azureBlobCDN}${AdvanceAPI}`,
        },
      ]}
    />
  </div>
</Modal>

<!-- ChatBot Toggler -->
{#if !isGuestUser && false}
  <div
    style="position: fixed;
        bottom: 28px;
        right:30px;
        z-index: 200;"
  >
    <div
      class="sparrow-ai-icon"
      role="button"
      on:click={() => {
        if ($tabsSplitterDirection != "horizontal") {
          tabsSplitterDirection.set("horizontal");
          isChatbotOpenInCurrTab.set(true);
        }
        onUpdateRequestState({
          isChatbotActive: !$tab?.property?.mockRequest?.state?.isChatbotActive,
        });

        MixpanelEvent(Events.AI_Chat_Initiation);
      }}
    >
      <div
        class="chatten-box"
        tabindex="0"
        style="display: {!$tab?.property?.mockRequest?.state?.isChatbotActive
          ? 'flex'
          : 'none'}"
      >
        <SparrowSecondaryIcon />
      </div>
    </div>
  </div>
{/if}

<style>
  .chatten-box {
    background-color: var(--bg-ds-primary-400);
    height: 40px;
    width: 40px;
    border-radius: 6px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .chatten-box:hover {
    background-color: var(--bg-ds-primary-500);
  }
  .chatten-box:focus-visible {
    height: 40px;
    width: 40px;
    border-radius: 10px;
    border: 2px solid var(--border-ds-primary-300);
    outline: none;
  }

  .rest-explorer-layout {
    background-color: var(--bg-ds-surface-900);
  }

  :global(.rest-splitter.splitpanes--vertical > .splitpanes__splitter) {
    width: 11px !important;
    height: 100% !important;
    background-color: var(--bg-secondary-500) !important;
    border-left: 5px solid var(--border-ds-surface-900) !important;
    border-right: 5px solid var(--border-ds-surface-900) !important;
    border-top: 0 !important;
    border-bottom: 0 !important;
  }
  :global(.rest-splitter.splitpanes--horizontal > .splitpanes__splitter) {
    height: 11px !important;
    width: 100% !important;
    background-color: var(--bg-ds-surface-100) !important;
    border-top: 5px solid var(--border-ds-surface-900) !important;
    border-bottom: 5px solid var(--border-ds-surface-900) !important;
    border-left: 0 !important;
    border-right: 0 !important;
  }
  :global(
    .rest-splitter > .splitpanes__splitter:active,
    .rest-splitter > .splitpanes__splitter:hover
  ) {
    background-color: var(--bg-ds-primary-400) !important;
  }

  /* Disabling the splitter for explorer and chatbot interface - only split dragger is allowed on hover */
  :global(
    .explorer-chatbot-splitter.splitpanes--vertical > .splitpanes__splitter
  ) {
    width: 8px !important;
    border: none !important;
    background: transparent !important;
  }

  :global(
    .explorer-chatbot-splitter.splitpanes--vertical
      > .splitpanes__splitter:hover,
    .explorer-chatbot-splitter.splitpanes--vertical
      > .splitpanes__splitter:active
  ) {
    border: none !important;
    border-right: 2px solid var(--border-ds-primary-300) !important;
    background: transparent !important;
  }

  .link {
    color: var(--text-primary-300);
    text-decoration: underline;
    cursor: pointer;
  }
</style>
