<script lang="ts">
  import {
    HttpUrlSection,
    RequestHeaders,
    RequestNavigator,
    ResponseNavigator,
    ResponseDefaultScreen,
    ResponseHeaders,
    ResponseBodyNavigator,
    RequestBody,
    ResponseBody,
    RequestParameters,
    RequestDoc,
  } from "../components";
  import { Splitpanes, Pane } from "svelte-splitpanes";
  import type { Observable } from "rxjs";
  import {
    RequestSectionEnum,
    ResponseSectionEnum,
    type KeyValue,
  } from "@sparrow/common/types/workspace/http-request-saved-tab";
  import { tabsSplitterDirection } from "../../../stores";
  import type { Tab } from "@sparrow/common/types/workspace/tab";
  import { ChevronRightRegular } from "@sparrow/library/icons";

  export let tab: Observable<Tab>;
  export let requestAuthHeader: Observable<KeyValue>;
  export let requestAuthParameter: Observable<KeyValue>;
  export let onUpdateRequestUrl;
  export let onSendRequest;
  export let onUpdateRequestMethod;
  export let onUpdateRequestParams;
  export let onUpdateRequestBody;
  export let onUpdateHeaders;
  export let onUpdateAutoGeneratedHeaders;
  export let onUpdateRequestState;
  export let onUpdateResponseBody;
  export let onClearResponse;
  export let onSaveRequest;
  export let onUpdateRequestDescription;
  export let onUpdateEnvironment;
  export let environmentVariables;
  export let isGuestUser = false;
  export let onGenerateDocumentation;
  export let userRole;
  export let isWebApp = false;
  export let onFetchParentRequest;
  export let onUpdateResponseState;

  let parentRequest: {
    name: string;
  };
  let isLoading = false;

  const fetchRequestData = async () => {
    parentRequest = await onFetchParentRequest(
      $tab.path.collectionId,
      $tab.path.requestId,
      $tab.path.folderId,
    );
  };

  $: {
    if ($tab?.tabId) {
      fetchRequestData();
    }
  }
</script>

{#if $tab.tabId}
  <div class="d-flex rest-explorer-layout h-100">
    <div class="w-100 d-flex flex-column h-100 px-3 pt-3 pb-2">
      <!-- HTTP URL Section -->
      <HttpUrlSection
        class=""
        isSave={$tab.isSaved}
        {userRole}
        requestUrl={$tab.property.savedRequest?.url}
        httpMethod={$tab.property.savedRequest?.method}
        onSendButtonClicked={onSendRequest}
        {onUpdateEnvironment}
        {environmentVariables}
        {onUpdateRequestUrl}
        {onUpdateRequestMethod}
        {onSaveRequest}
        {isGuestUser}
      />
      <!--Disabling the Quick Help feature, will be taken up in next release-->
      <div class="" style="margin-top: 10px;"></div>
      <div class="pt-2"></div>
      <div style="flex:1; overflow:auto;">
        {#if !isLoading}
          <Splitpanes
            class="rest-splitter-saved w-100 h-100"
            id={"rest-splitter-saved"}
            horizontal={$tabsSplitterDirection === "horizontal" ? true : false}
            dblClickSplitter={false}
            on:resize={(e) => {
              onUpdateRequestState({
                requestLeftSplitterWidthPercentage: e.detail[0].size,
              });
              onUpdateRequestState({
                requestRightSplitterWidthPercentage: e.detail[1].size,
              });
            }}
          >
            <Pane
              minSize={30}
              size={$tab.property.savedRequest?.state
                ?.requestLeftSplitterWidthPercentage}
              class="position-relative bg-transparent"
            >
              <!-- Request Pane -->
              <div
                class="h-100 d-flex flex-column position-relative {$tabsSplitterDirection ===
                'horizontal'
                  ? 'pb-1'
                  : 'pe-2'}"
              >
                <div class="d-flex breadcrump-txt">
                  <span class="parent-txt">{parentRequest?.name}</span>
                  <ChevronRightRegular
                    size={"12px"}
                    color="var(--icon-ds-neutral-400)"
                  />
                  <span class="request-txt">{$tab.name}</span>
                </div>
                <div class="breadcrump-line" />
                <RequestNavigator
                  requestStateSection={$tab.property.savedRequest?.state
                    ?.requestNavigation}
                  {onUpdateRequestState}
                  authParameterLength={$requestAuthParameter.value ? 1 : 0}
                  authHeaderLength={$requestAuthHeader.value ? 1 : 0}
                  paramsLength={$tab.property?.savedRequest?.queryParams
                    ?.length || 0}
                  headersLength={$tab.property?.savedRequest?.headers?.length ||
                    0}
                  autoGeneratedHeadersLength={$tab.property?.savedRequest
                    ?.autoGeneratedHeaders?.length || 0}
                />
                <div style="flex:1; overflow:auto;" class="p-0">
                  {#if $tab.property.savedRequest?.state?.requestNavigation === RequestSectionEnum.PARAMETERS}
                    <RequestParameters
                      isBulkEditActive={$tab?.property?.savedRequest.state
                        ?.isParameterBulkEditActive}
                      {onUpdateRequestState}
                      params={$tab.property.savedRequest.queryParams}
                      {onUpdateRequestParams}
                      authParameter={$requestAuthParameter}
                      {onUpdateEnvironment}
                      {environmentVariables}
                    />
                  {:else if $tab.property.savedRequest?.state?.requestNavigation === RequestSectionEnum.REQUEST_BODY}
                    <RequestBody
                      body={$tab.property.savedRequest.body}
                      method={$tab.property.savedRequest.method}
                      requestState={$tab.property.savedRequest.state}
                      {onUpdateRequestBody}
                      {onUpdateRequestState}
                      {onUpdateEnvironment}
                      {environmentVariables}
                      {isWebApp}
                    />
                  {:else if $tab.property.savedRequest?.state?.requestNavigation === RequestSectionEnum.HEADERS}
                    <RequestHeaders
                      isBulkEditActive={$tab?.property?.savedRequest.state
                        ?.isHeaderBulkEditActive}
                      {onUpdateRequestState}
                      {environmentVariables}
                      {onUpdateEnvironment}
                      headers={$tab.property.savedRequest.headers}
                      autoGeneratedHeaders={$tab.property.savedRequest
                        .autoGeneratedHeaders}
                      authHeader={$requestAuthHeader}
                      onHeadersChange={onUpdateHeaders}
                      onAutoGeneratedHeadersChange={onUpdateAutoGeneratedHeaders}
                      {isWebApp}
                    />
                  {:else if $tab.property.savedRequest?.state?.requestNavigation === RequestSectionEnum.DOCUMENTATION}
                    <RequestDoc
                      isDocGenerating={$tab.property.savedRequest?.state
                        ?.isDocGenerating}
                      isDocAlreadyGenerated={$tab.property.savedRequest?.state
                        ?.isDocAlreadyGenerated}
                      {onGenerateDocumentation}
                      {onUpdateRequestDescription}
                      requestDoc={$tab.description}
                      {isGuestUser}
                    />
                  {/if}
                </div>
              </div>
            </Pane>
            <Pane
              minSize={30}
              size={$tab.property.savedRequest?.state
                ?.requestRightSplitterWidthPercentage}
              class="bg-transparent position-relative"
            >
              <!-- Response Pane -->
              <div
                class="d-flex flex-column h-100 {$tabsSplitterDirection ===
                'horizontal'
                  ? 'pt-1'
                  : 'ps-2'}"
                style="overflow:auto;"
              >
                <div class="h-100 d-flex flex-column">
                  <div style="flex:1; overflow:auto;">
                    <div class="h-100 d-flex flex-column">
                      <!-- <ResponseStatus response={storeData.response} /> -->
                      <ResponseNavigator
                        requestStateSection={$tab.property.savedRequest?.state
                          ?.responseNavigation}
                        statusCodes={$tab.property.savedRequest?.responseStatus}
                        date={$tab.property.savedRequest?.responseDate}
                        {onUpdateRequestState}
                        responseHeadersLength={$tab.property.savedRequest
                          ?.responseHeaders?.length || 0}
                      />
                      {#if $tab.property.savedRequest?.state?.responseNavigation === ResponseSectionEnum.RESPONSE}
                        {#if $tab.property.savedRequest?.state?.responseBodyLanguage !== "Image"}
                          <ResponseBodyNavigator
                            response={$tab.property.savedRequest?.headers || []}
                            body={$tab.property.savedRequest?.responseBody}
                            apiState={$tab.property.savedRequest?.state}
                            {onUpdateRequestState}
                            {onUpdateResponseState}
                            {onClearResponse}
                            {isWebApp}
                          />
                        {/if}
                        <div style="flex:1; overflow:auto;">
                          <ResponseBody
                            response={$tab.property.savedRequest?.responseBody}
                            apiState={$tab.property.savedRequest?.state}
                            {onUpdateResponseBody}
                          />
                        </div>
                      {:else if $tab.property.savedRequest?.state?.responseNavigation === ResponseSectionEnum.HEADERS}
                        <div style="flex:1; overflow:auto;">
                          <ResponseHeaders
                            responseHeader={$tab.property.savedRequest
                              ?.responseHeaders || []}
                          />
                        </div>
                      {/if}
                    </div>
                  </div>
                </div>
              </div></Pane
            >
          </Splitpanes>
        {:else}
          <!-- loading state -->
          <ResponseDefaultScreen isMainScreen={true} />
        {/if}
      </div>
    </div>
  </div>
{/if}

<style>
  .rest-explorer-layout {
    background-color: var(--bg-ds-surface-900);
  }

  :global(.rest-splitter-saved.splitpanes--vertical > .splitpanes__splitter) {
    width: 11px !important;
    height: 100% !important;
    background-color: var(--bg-secondary-500) !important;
    border-left: 5px solid var(--border-ds-surface-900) !important;
    border-right: 5px solid var(--border-ds-surface-900) !important;
    border-top: 0 !important;
    border-bottom: 0 !important;
  }
  :global(.rest-splitter-saved.splitpanes--horizontal > .splitpanes__splitter) {
    height: 11px !important;
    width: 100% !important;
    background-color: var(--bg-secondary-500) !important;
    border-top: 5px solid var(--border-ds-surface-900) !important;
    border-bottom: 5px solid var(--border-ds-surface-900) !important;
    border-left: 0 !important;
    border-right: 0 !important;
  }
  :global(
    .rest-splitter-saved > .splitpanes__splitter:active,
    .rest-splitter-saved > .splitpanes__splitter:hover
  ) {
    background-color: var(--bg-primary-200) !important;
  }
  .link {
    color: var(--text-primary-300);
    text-decoration: underline;
    cursor: pointer;
  }
  .parent-txt {
    color: var(--text-ds-neutral-100);
    font-size: 12px;
    font-weight: 500;
    padding-right: 10px;
  }
  .request-txt {
    color: var(--text-ds-neutral-500);
    font-size: 12px;
    font-weight: 500;
    padding-left: 10px;
  }
  .breadcrump-txt {
    padding-left: 12px;
    padding-bottom: 14px;
  }
  .breadcrump-line {
    width: 100%;
    border: 1px solid var(--border-ds-surface-50);
    margin-bottom: 2px;
  }
</style>
