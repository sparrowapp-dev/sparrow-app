<script lang="ts">
  // ---- Assets
  import { floppyDiskIcon as floppyDisk } from "@sparrow/library/assets";

  // ---- Components
  import {
    HttpUrlSection,
    RequestHeaders,
    RequestNavigator,
    ResponseNavigator,
    RequestAuth,
    ResponseDefaultScreen,
    ResponseErrorScreen,
    ResponseHeaders,
    ResponseBodyNavigator,
    RequestBody,
    RequestName,
    ResponseBody,
    RestExtensionPanel,
    RequestParameters,
    ResponseStatus,
  } from "../components";
  import { Loader } from "@sparrow/library/ui";
  import { notifications } from "@sparrow/library/ui";
  import { Splitpanes, Pane } from "svelte-splitpanes";
  import { Button } from "@sparrow/library/ui";

  import type { CollectionDocument } from "@app/database/database";
  import type { Observable } from "rxjs";
  import { SaveAsCollectionItem } from "@sparrow/workspaces/features";
  import type {
    ClearResponseType,
    CreateCollectionType,
    CreateFolderType,
    ReadCollectionType,
    ReadRequestOrFolderInCollectionType,
    ReadWorkspaceType,
    SaveAsRequestType,
    SaveRequestType,
    SendRequestType,
    UpdateAutoGeneratedHeadersType,
    UpdateHeadersType,
    UpdateParamsType,
    UpdateRequestAuthType,
    UpdateRequestBodyType,
    UpdateRequestDescriptionType,
    UpdateRequestMethodType,
    UpdateRequestNameType,
    UpdateRequestStateType,
    UpdateRequestUrlType,
  } from "@sparrow/workspaces/type";
  import {
    RequestSectionEnum,
    ResponseSectionEnum,
    type KeyValue,
    type RequestTab,
  } from "@sparrow/common/types/workspace";
  import { requestSplitterDirection } from "../store";
  import { Popover } from "@sparrow/library/ui";
  import { onMount } from "svelte";
  import { Carousel, Modal } from "@sparrow/library/ui";
  import RequestDoc from "../components/request-doc/RequestDoc.svelte";
  import {
    AdvanceAPI,
    CreateCollection,
    SendingApiRequest,
  } from "@sparrow/workspaces/constants";
  import { ResponseStatusCode } from "@sparrow/common/enums";

  import type { CancelRequestType } from "@workspaces/common/type/actions";
  import type { restExplorerData } from "../store/rest-explorer";

  export let tab: Observable<RequestTab>;
  export let collections: Observable<CollectionDocument[]>;
  export let requestAuthHeader: Observable<KeyValue>;
  export let requestAuthParameter: Observable<KeyValue>;
  export let onUpdateRequestUrl: UpdateRequestUrlType;
  export let onSendRequest: SendRequestType;
  export let onCancelRequest: CancelRequestType;
  export let onUpdateRequestMethod: UpdateRequestMethodType;
  export let onUpdateRequestParams: UpdateParamsType;
  export let onUpdateRequestName: UpdateRequestNameType;
  export let onUpdateRequestBody: UpdateRequestBodyType;
  export let onUpdateRequestAuth: UpdateRequestAuthType;
  export let onUpdateHeaders: UpdateHeadersType;
  export let onUpdateAutoGeneratedHeaders: UpdateAutoGeneratedHeadersType;
  export let onUpdateRequestState: UpdateRequestStateType;
  export let onUpdateResponseState;
  export let onClearResponse: ClearResponseType;
  export let onSaveRequest: SaveRequestType;
  export let onUpdateRequestDescription: UpdateRequestDescriptionType;
  export let readRequestOrFolderInCollection: ReadRequestOrFolderInCollectionType;
  export let readCollection: ReadCollectionType;
  export let readWorkspace: ReadWorkspaceType;
  export let onSaveAsRequest: SaveAsRequestType;
  export let onCreateFolder: CreateFolderType;
  export let onCreateCollection: CreateCollectionType;
  export let onUpdateEnvironment;
  export let environmentVariables;
  export let isGuestUser = false;
  // export let isLoginBannerActive = false;
  export let isPopoverContainer = true;
  export let onFetchCollectionGuide: (query) => void;
  export let onUpdateCollectionGuide: (query, isActive) => void;
  // export let onUpdateAiPrompt;
  // export let onUpdateAiConversation;
  export let onGenerateDocumentation;
  /**
   * Role of user in active workspace
   */
  export let userRole;
  export let storeData: restExplorerData | undefined;
  export let isTourGuideOpen = false;

  const closeCollectionHelpText = () => {
    onUpdateCollectionGuide({ id: "collection-guide" }, false);
    isPopoverContainer = !isPopoverContainer;
  };

  onMount(async () => {
    const event = await onFetchCollectionGuide({
      id: "collection-guide",
    });
    event?.$.subscribe((e) => {
      if (e.isActive === false) {
        isPopoverContainer = false;
      } else {
        isPopoverContainer = true;
      }
    });
  });
  export let onRenameCollection;
  export let onRenameFolder;

  let isExposeSaveAsRequest = false;
  let isLoading = true;
  $: {
    if ($tab?.property?.request?.url?.length > 0) {
      isLoading = false;
    }
  }
  $: {
    if (isTourGuideOpen) {
      isGuidePopup = true;
    }
  }
  const toggleSaveRequest = (flag: boolean): void => {
    isExposeSaveAsRequest = flag;
  };
  let isGuidePopup = false;
</script>

{#if $tab.tabId}
  <div class="d-flex rest-explorer-layout h-100">
    <div class="w-100 d-flex flex-column h-100 px-3 pt-3 pb-2">
      <!-- Request Name Header -->
      <!-- 
        --
        -- Rest name header is set to display none 
        --
      -->
      <div class="d-flex justify-content-between w-100 p-3 d-none">
        <RequestName name={$tab.name} {onUpdateRequestName} />

        <div class="d-flex justify-content-between">
          <Button
            title="Save Request"
            type="dark"
            loader={false}
            buttonClassProp="ms-2"
            buttonStartIcon={floppyDisk}
            onClick={async () => {
              const x = await onSaveRequest();
              if (
                x.status === "error" &&
                x.message ===
                  "request is not a part of any workspace or collection"
              ) {
                isExposeSaveAsRequest = true;
              } else if (x.status === "success") {
                notifications.success("API request saved successfully.");
              }
            }}
          />

          <span class="position-relative" style="width:35px;"> </span>
          <Button
            title="Share"
            type="dark"
            buttonClassProp="ms-2"
            onClick={() => {}}
          />
        </div>
      </div>

      <!-- HTTP URL Section -->
      <HttpUrlSection
        class=""
        isSave={$tab.isSaved}
        bind:userRole
        requestUrl={$tab.property.request.url}
        httpMethod={$tab.property.request.method}
        isSendRequestInProgress={storeData?.isSendRequestInProgress}
        onSendButtonClicked={onSendRequest}
        onCancelButtonClicked={onCancelRequest}
        {onUpdateEnvironment}
        {environmentVariables}
        {onUpdateRequestUrl}
        {onUpdateRequestMethod}
        {toggleSaveRequest}
        {onSaveRequest}
        {isGuestUser}
      />
      <!--Disabling the Quick Help feature, will be taken up in next release-->
      <div class="" style="margin-top: 10px;">
        {#if isPopoverContainer}
          <Popover
            onClose={closeCollectionHelpText}
            heading={`Welcome to Sparrow!`}
            text={` `}
          >
            <p>
              Your one-stop solution for API testing and management. Start
              organizing your API requests into collections, utilize environment
              variables, and streamline your development process. Get started
              now by creating your first collection or exploring our features
              <span
                on:click={() => {
                  isGuidePopup = true;
                }}
                class="link btn p-0 border-0"
                style="font-size: 12px;"
                >See how it works.
              </span>
            </p>
          </Popover>
        {/if}
      </div>
      <div class="pt-2"></div>
      <div style="flex:1; overflow:auto;">
        {#if !isLoading}
          <Splitpanes
            class="rest-splitter w-100 h-100"
            id={"rest-splitter"}
            horizontal={$requestSplitterDirection === "horizontal"
              ? true
              : false}
            dblClickSplitter={false}
            on:resize={(e) => {
              onUpdateRequestState({
                requestLeftSplitterWidthPercentage: e.detail[0].size,
              });
              onUpdateRequestState({
                requestRightSplitterWidthPercentage: e.detail[1].size,
              });
            }}
          >
            <Pane
              minSize={30}
              size={$tab.property.request?.state
                ?.requestLeftSplitterWidthPercentage}
              class="position-relative bg-secondary-850-important"
            >
              <!-- Request Pane -->
              <div
                class="h-100 d-flex flex-column position-relative {$requestSplitterDirection ===
                'horizontal'
                  ? 'pb-1'
                  : 'pe-2'}"
              >
                <RequestNavigator
                  requestStateSection={$tab.property.request?.state
                    ?.requestNavigation}
                  {onUpdateRequestState}
                  authParameterLength={$requestAuthParameter.value ? 1 : 0}
                  authHeaderLength={$requestAuthHeader.value ? 1 : 0}
                  paramsLength={$tab.property?.request?.queryParams?.length ||
                    0}
                  headersLength={$tab.property?.request?.headers?.length || 0}
                  autoGeneratedHeadersLength={$tab.property?.request
                    ?.autoGeneratedHeaders?.length || 0}
                />
                <div style="flex:1; overflow:auto;" class="p-0">
                  {#if $tab.property.request?.state?.requestNavigation === RequestSectionEnum.PARAMETERS}
                    <RequestParameters
                      isBulkEditActive={$tab?.property?.request.state
                        ?.isParameterBulkEditActive}
                      {onUpdateRequestState}
                      params={$tab.property.request.queryParams}
                      {onUpdateRequestParams}
                      authParameter={$requestAuthParameter}
                      {onUpdateEnvironment}
                      {environmentVariables}
                    />
                  {:else if $tab.property.request?.state?.requestNavigation === RequestSectionEnum.REQUEST_BODY}
                    <RequestBody
                      body={$tab.property.request.body}
                      method={$tab.property.request.method}
                      requestState={$tab.property.request.state}
                      {onUpdateRequestBody}
                      {onUpdateRequestState}
                      {onUpdateEnvironment}
                      {environmentVariables}
                    />
                  {:else if $tab.property.request?.state?.requestNavigation === RequestSectionEnum.HEADERS}
                    <RequestHeaders
                      isBulkEditActive={$tab?.property?.request.state
                        ?.isHeaderBulkEditActive}
                      {onUpdateRequestState}
                      {environmentVariables}
                      {onUpdateEnvironment}
                      headers={$tab.property.request.headers}
                      autoGeneratedHeaders={$tab.property.request
                        .autoGeneratedHeaders}
                      authHeader={$requestAuthHeader}
                      onHeadersChange={onUpdateHeaders}
                      onAutoGeneratedHeadersChange={onUpdateAutoGeneratedHeaders}
                    />
                  {:else if $tab.property.request?.state?.requestNavigation === RequestSectionEnum.AUTHORIZATION}
                    <RequestAuth
                      requestStateAuth={$tab.property.request.state
                        .requestAuthNavigation}
                      {onUpdateRequestState}
                      auth={$tab.property.request.auth}
                      {onUpdateRequestAuth}
                      {onUpdateEnvironment}
                      {environmentVariables}
                    />
                  {:else if $tab.property.request?.state?.requestNavigation === RequestSectionEnum.DOCUMENTATION}
                    <RequestDoc
                      isDocGenerating={$tab.property.request?.state
                        ?.isDocGenerating}
                      isDocAlreadyGenerated={$tab.property.request?.state
                        ?.isDocAlreadyGenerated}
                      {onGenerateDocumentation}
                      {onUpdateRequestDescription}
                      requestDoc={$tab.description}
                      {isGuestUser}
                    />
                  {/if}
                </div>
              </div>
            </Pane>
            <Pane
              minSize={30}
              size={$tab.property.request?.state
                ?.requestRightSplitterWidthPercentage}
              class="bg-secondary-850-important position-relative"
            >
              <!-- Response Pane -->
              <div
                class="d-flex flex-column h-100 {$requestSplitterDirection ===
                'horizontal'
                  ? 'pt-1'
                  : 'ps-2'}"
                style="overflow:auto;"
              >
                <div class="h-100 d-flex flex-column">
                  <div style="flex:1; overflow:auto;">
                    {#if storeData?.isSendRequestInProgress}
                      <ResponseDefaultScreen />
                      <div
                        style="top: 0px; left: 0; right: 0; bottom: 0; z-index:3; position:absolute;"
                      >
                        <Loader loaderSize={"20px"} />
                      </div>
                    {:else if !storeData?.response.status}
                      <ResponseDefaultScreen />
                    {:else if storeData?.response.status === ResponseStatusCode.ERROR}
                      <ResponseErrorScreen />
                    {:else if storeData?.response.status}
                      <div class="h-100 d-flex flex-column">
                        <ResponseStatus response={storeData.response} />
                        <ResponseNavigator
                          requestStateSection={storeData?.response.navigation}
                          {onUpdateResponseState}
                          responseHeadersLength={storeData?.response.headers
                            ?.length || 0}
                        />
                        {#if storeData?.response.navigation === ResponseSectionEnum.RESPONSE}
                          {#if storeData?.response.bodyLanguage !== "Image"}
                            <ResponseBodyNavigator
                              response={storeData?.response}
                              apiState={storeData?.response}
                              {onUpdateResponseState}
                              {onClearResponse}
                            />
                          {/if}
                          <div style="flex:1; overflow:auto;">
                            <ResponseBody
                              response={storeData?.response}
                              apiState={storeData?.response}
                            />
                          </div>
                        {:else if storeData?.response.navigation === ResponseSectionEnum.HEADERS}
                          <div style="flex:1; overflow:auto;">
                            <ResponseHeaders
                              responseHeader={storeData.response?.headers}
                            />
                          </div>
                        {/if}
                      </div>
                    {/if}
                  </div>
                </div>
              </div></Pane
            >
          </Splitpanes>
        {:else}
          <!-- loading state -->
          <ResponseDefaultScreen isMainScreen={true} />
        {/if}
      </div>
    </div>
    <!--
      --
       -- Rest extension panel is set to display none 
      --
    -->
    <div class="d-none">
      <RestExtensionPanel
        state={$tab.property.request?.state}
        requestMethod={$tab.property.request?.method}
        requestUrl={$tab.property.request?.url}
        requestName={$tab.name}
        requestDescription={$tab.description}
        requestPath={$tab.path}
        collections={$collections}
        {onSaveRequest}
        {readCollection}
        {readWorkspace}
        {onSaveAsRequest}
        {onCreateFolder}
        {onCreateCollection}
        {onUpdateRequestState}
        {onUpdateRequestDescription}
        {readRequestOrFolderInCollection}
      />
    </div>
  </div>
  <Modal
    title={"Save Request"}
    type={"dark"}
    width={"55%"}
    zIndex={10000}
    isOpen={isExposeSaveAsRequest}
    handleModalState={(flag = false) => {
      isExposeSaveAsRequest = flag;
    }}
  >
    <SaveAsCollectionItem
      onClick={(flag = false) => {
        isExposeSaveAsRequest = flag;
      }}
      requestMethod={$tab.property.request?.method}
      requestUrl={$tab.property.request?.url}
      requestName={$tab.name}
      requestDescription={$tab.description}
      requestPath={$tab.path}
      collections={$collections}
      {readWorkspace}
      onSave={onSaveAsRequest}
      {onCreateFolder}
      {onCreateCollection}
      {onRenameCollection}
      {onRenameFolder}
    />
  </Modal>
{/if}

<Modal
  title={""}
  type={"dark"}
  width={"474px"}
  zIndex={10000}
  isOpen={isGuidePopup}
  handleModalState={(flag = false) => {
    isGuidePopup = flag;
    isTourGuideOpen = false;
  }}
>
  <div style="position: relative;">
    <Carousel
      handleClosePopup={(flag = false) => {
        isGuidePopup = flag;
        isTourGuideOpen = false;
      }}
      data={[
        {
          id: 1,
          heading: "Creating a Collection: Import existing or Start a new one",
          subheading: `Organize your APIs efficiently within "Collections" for streamlined API management and testing. Click the + Add Collection button in the side panel to create a collection. Choose 'Import Collection' to bring in existing API collections or create an empty Collection. `,
          gif: `${CreateCollection}`,
        },
        {
          id: 2,
          heading: "Sending an API Request",
          subheading:
            "In the request builder, input your API endpoint URL in the URL field. Click the 'Send' button to dispatch the request. Instantly see the server's response, which includes status codes, response time, and data.",
          gif: `${SendingApiRequest}`,
        },
        {
          id: 3,
          heading: "Advanced API Request with Detailed Inputs",
          subheading:
            "Enter the endpoint URL in the URL field. Utilize 'Parameters' tab for parameters, 'Body' tab to input data payloads, 'Headers' tab for custom headers, and 'Auth' tab to manage access credentials. After filling in the required fields, click 'Send' to execute the request and view the detailed server response.",
          gif: `${AdvanceAPI}`,
        },
      ]}
    />
  </div>
</Modal>

<style>
  .rest-explorer-layout {
    background-color: var(--bg-secondary-850);
  }

  :global(.rest-splitter.splitpanes--vertical .splitpanes__splitter) {
    width: 10.5px !important;
    height: 100% !important;
    background-color: var(--bg-secondary-500) !important;
    border-left: 5px solid var(--border-secondary-800) !important;
    border-right: 5px solid var(--border-secondary-800) !important;
    border-top: 0 !important;
    border-bottom: 0 !important;
  }
  :global(.rest-splitter.splitpanes--horizontal .splitpanes__splitter) {
    height: 10.5px !important;
    width: 100% !important;
    background-color: var(--bg-secondary-500) !important;
    border-top: 5px solid var(--border-secondary-800) !important;
    border-bottom: 5px solid var(--border-secondary-800) !important;
    border-left: 0 !important;
    border-right: 0 !important;
  }
  :global(
      .rest-splitter .splitpanes__splitter:active,
      .rest-splitter .splitpanes__splitter:hover
    ) {
    background-color: var(--bg-primary-200) !important;
  }
  .link {
    color: var(--bg-primary-300);
    text-decoration: underline;
  }
</style>
