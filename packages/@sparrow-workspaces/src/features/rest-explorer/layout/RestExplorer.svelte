<script lang="ts">
  // ---- Assets
  import { floppyDiskIcon as floppyDisk } from "@sparrow/library/assets";

  // ---- Components
  import {
    HttpUrlSection,
    RequestHeaders,
    RequestNavigator,
    ResponseNavigator,
    RequestAuth,
    ResponseDefaultScreen,
    ResponseErrorScreen,
    ResponseHeaders,
    ResponseBodyNavigator,
    RequestBody,
    RequestName,
    ResponseBody,
    RestExtensionPanel,
    RequestParameters,
    ResponseStatus,
    RequestTests,
  } from "../components";
  import { Loader } from "@sparrow/library/ui";
  import { notifications } from "@sparrow/library/ui";
  import { Splitpanes, Pane } from "svelte-splitpanes";
  import { Button } from "@sparrow/library/ui";
  import { TestCaseModeEnum } from "@sparrow/common/types/workspace";

  import MixpanelEvent from "@app/utils/mixpanel/MixpanelEvent";
  import type { CollectionDocument } from "@app/database/database";
  import {
    Events,
    RequestDataset,
    RequestDataType,
  } from "@sparrow/common/enums";
  import type { Observable } from "rxjs";
  import {
    RequestTabTourGuide,
    SaveAsCollectionItem,
  } from "@sparrow/workspaces/features";
  import type {
    ClearResponseType,
    CreateCollectionType,
    CreateFolderType,
    ReadCollectionType,
    ReadRequestOrFolderInCollectionType,
    ReadWorkspaceType,
    SaveAsRequestType,
    SaveRequestType,
    SendRequestType,
    UpdateAutoGeneratedHeadersType,
    UpdateHeadersType,
    UpdateParamsType,
    UpdateRequestAuthType,
    UpdateRequestBodyType,
    UpdateRequestDescriptionType,
    UpdateRequestMethodType,
    UpdateRequestNameType,
    UpdateRequestStateType,
    UpdateRequestUrlType,
  } from "@sparrow/workspaces/type";
  import {
    RequestDatasetEnum,
    RequestDataTypeEnum,
    RequestSectionEnum,
    ResponseSectionEnum,
    type KeyValue,
  } from "@sparrow/common/types/workspace";
  import {
    tabsSplitterDirection,
    isChatbotOpenInCurrTab,
    requestTabTestDemo,
    requestTabTestNoCodeStep,
    requestTabTestScriptDemo,
    requestTabTestScriptStep,
  } from "../../../stores";
  import { Popover } from "@sparrow/library/ui";
  import { onDestroy, onMount } from "svelte";
  import { Carousel, Modal } from "@sparrow/library/ui";
  import RequestDoc from "../components/request-doc/RequestDoc.svelte";
  import {
    AdvanceAPI,
    CreateCollection,
    SendingApiRequest,
  } from "@sparrow/workspaces/constants";
  import { ResponseStatusCode } from "@sparrow/common/enums";

  import type { CancelRequestType } from "@workspaces/common/type/actions";
  import type { restExplorerData } from "../store/rest-explorer";
  import type { Tab } from "@sparrow/common/types/workspace/tab";
  import {
    CheckmarkCircleFilled,
    ErrorCircleFilled,
    CaretDownFilled,
  } from "@sparrow/library/icons";

  import { SparrowSecondaryIcon, SparkleFilled } from "@sparrow/common/icons";
  import { loadingState } from "../../../../../@sparrow-common/src/store";
  import { writable } from "svelte/store";
  import { AIChatInterface } from "../../chat-bot/components";
  import { ChatBot } from "../../chat-bot";
  import type { KeyValuePair } from "@sparrow/common/interfaces/request.interface";
  import { captureEvent } from "@app/utils/posthog/posthogConfig";
  import { Motion } from "svelte-motion";
  import {
    chatbotOpenAnimation,
    chatbotClosedAnimation,
    chatbotCloseTransition,
    chatbotOpenTransition,
  } from "../utils";

  import { policyConfig } from "@sparrow/common/store";
  import RequestTourGuideCard from "../components/request-tour-guide-card/RequestTourGuideCard.svelte";
  import { tick } from "svelte";
  import ResponseTestResults from "../components/response-test-results/ResponseTestResults.svelte";
  import TourGuideCard from "../../request-tab-tour-guide/components/TourGuideCard.svelte";
  import {
    requestTabScriptCardPosition,
    RequestTabTestsScriptTourContent,
    RequestTabTestsTourContent,
  } from "../../request-tab-tour-guide/utils";
  import { requestTabNocodeCardPosition } from "../../request-tab-tour-guide/utils";
  import {
    handleCloseTour,
    handleNextStep,
  } from "../../request-tab-tour-guide/utils/requestTabCardfunctions";
  export let tab: Observable<Tab>;
  export let collections: Observable<CollectionDocument[]>;
  export let requestAuthHeader: Observable<KeyValue>;
  export let requestAuthParameter: Observable<KeyValue>;
  export let onUpdateRequestUrl: UpdateRequestUrlType;
  export let onSendRequest: SendRequestType;
  export let onCancelRequest: CancelRequestType;
  export let onUpdateRequestMethod: UpdateRequestMethodType;
  export let onUpdateRequestParams: UpdateParamsType;
  export let onUpdateRequestName: UpdateRequestNameType;
  export let onUpdateRequestBody: UpdateRequestBodyType;
  export let onUpdateRequestAuth: UpdateRequestAuthType;
  export let onUpdateHeaders: UpdateHeadersType;
  export let onUpdateAutoGeneratedHeaders: UpdateAutoGeneratedHeadersType;
  export let onUpdateRequestState: UpdateRequestStateType;
  export let onUpdateResponseState;
  export let onClearResponse: ClearResponseType;
  export let onSaveRequest: SaveRequestType;
  export let onUpdateRequestDescription: UpdateRequestDescriptionType;
  export let readRequestOrFolderInCollection: ReadRequestOrFolderInCollectionType;
  export let readCollection: ReadCollectionType;
  export let readWorkspace: ReadWorkspaceType;
  export let onSaveAsRequest: SaveAsRequestType;
  export let onCreateFolder: CreateFolderType;
  export let onCreateCollection: CreateCollectionType;
  export let onUpdateEnvironment;
  export let environmentVariables;
  export let isGuestUser = false;
  export let onOpenCollection;
  export let updateIsGeneratedVariable: (value: boolean) => void;
  export let handleGenerateVariableDemo: (
    collectionId: string | undefined,
    workspaceId: string,
  ) => void;
  export let InsertGenerateTrialFlow: (
    collectionId: string | undefined,
  ) => void;

  export let onGenerateAiResponse;
  export let onToggleLike;
  export let isCloseRequestTestDemo: (value: boolean) => void;
  export let requestTabTestsDemoCompleted: () => void;
  export let isCloseRequestTestScriptDemo: (value: boolean) => void;
  export let requestTabTestScriptDemoCompleted: () => void;

  // export let isLoginBannerActive = false;
  export let isPopoverContainer = true;
  export let onFetchCollectionGuide: (query) => void;
  export let onUpdateCollectionGuide: (query, isActive) => void;
  export let onUpdateAiPrompt;
  export let onUpdateAiConversation;
  export let onUpdateTests;
  export let onUpdateAiModel;
  export let onGenerateDocumentation;
  export let onStopGeneratingAIResponse;
  export let generateMockData: () => any;

  /**
   * Role of user in active workspace
   */
  export let userRole;
  export let storeData: restExplorerData | undefined;
  export let isTourGuideOpen = false;
  export let isWebApp = false;
  export let azureBlobCDN;
  export let onSaveResponse;
  export let collectionAuth;
  export let collection;
  export let isSharedWorkspace = false;
  export let onFixTestScript;
  const isTestCasesGenerating = writable<boolean>(false);

  const loading = writable<boolean>(false);
  // Props for showing merge/diff view in RequestBody, Headers and Params
  let isAIDebugBtnEnable = false;
  export let isMergeViewEnableForRequestBody = false;
  export let isMergeViewEnableForParams = false;
  export let isMergeViewEnableForHeaders = false;
  export let isMergeViewLoading = false;
  export let newModifiedContent: string | KeyValuePair[];
  export let mergeViewRequestDatasetType: RequestDatasetEnum;

  //props for generating test cases function
  export let onGenerateTestCases;

  // Reference to the splitpane container element
  let splitpaneContainer;
  let splitpaneContainerWidth = 0;

  // Chatbot pane size constraints in pixels (based on Figma design)
  const minPx = 343;
  const maxPx = 525;
  const defaultPx = 452;

  // Chatbot pane size constraints in percentage (calculated at runtime)
  let minSizePct = 0;
  let maxSizePct = 0;
  let defaultSizePct = 0;

  let isGenerateMockDataModal = false;

  /**
   * Converts the pixel-based min, max, and default sizes
   * of the chatbot pane into percentages relative to the
   * current width of the splitpane container.
   *
   * Required because `svelte-splitpane` accepts sizes in percentages.
   */
  function updateSplitpaneContSizes() {
    if (!splitpaneContainer) return;

    splitpaneContainerWidth = splitpaneContainer.clientWidth;

    minSizePct = (minPx / splitpaneContainerWidth) * 100;
    maxSizePct = (maxPx / splitpaneContainerWidth) * 100;
    defaultSizePct = (defaultPx / splitpaneContainerWidth) * 100;
  }

  const closeCollectionHelpText = () => {
    onUpdateCollectionGuide({ id: "collection-guide" }, false);
    isPopoverContainer = !isPopoverContainer;
  };

  onMount(async () => {
    const event = await onFetchCollectionGuide({
      id: "collection-guide",
    });
    event?.$.subscribe((e) => {
      if (e.isActive === false) {
        isPopoverContainer = false;
      } else {
        isPopoverContainer = true;
      }
    });

    // Delay to ensure DOM is ready before measuring container width
    setTimeout(() => {
      updateSplitpaneContSizes();
      // Watch for container size changes and update pane size percentages
      const resizeObserver = new ResizeObserver(() => {
        updateSplitpaneContSizes();
      });
      resizeObserver.observe(splitpaneContainer);
      return () => resizeObserver.disconnect(); // Cleanup on component unmount
    }, 0);
  });

  export let onRenameCollection;
  export let onRenameFolder;

  let isExposeSaveAsRequest = false;
  let isLoading = true;
  let isErrorMsgOpen = false;

  $: {
    if ($tab?.property?.request?.url?.length > 0) {
      isLoading = false;
    }
  }
  $: {
    if (isTourGuideOpen) {
      isGuidePopup = true;
    }
  }
  const toggleSaveRequest = (flag: boolean): void => {
    isExposeSaveAsRequest = flag;
  };

  $: {
    loadingState.subscribe((tab) => {
      loading.set(tab.get($tab.tabId));
    });
  }

  $: {
    loadingState.subscribe((tab) => {
      isTestCasesGenerating.set(tab.get($tab.tabId + "generatingTestCases"));
    });
  }
  let isGuidePopup = false;

  // Here we are closing the chatbot when user switches to vertical layout view.
  // This can be handled with a better approach, as its not user friendly way
  // that we are closing the Chatbot interface with respect to vertical layout switching
  // $: {
  //   if (!isLoading && $tabsSplitterDirection != "horizontal") {
  //     console.log("not active chatbox!!");
  //     onUpdateRequestState({
  //       isChatbotActive: false,
  //     });
  //   }
  // }
  $: if (!isGuestUser && $tab?.property?.request?.state?.isChatbotActive) {
    isChatbotOpenInCurrTab.set(true);
  }
  onDestroy(() => {
    isChatbotOpenInCurrTab.set(false);
  });

  /**
   * Enables the diff/merge view while having suggested changes by AI
   * @param newContent The new changes suggested
   * @param requestDatasetType Request Body dataset type (Raw, Binary, URL Encoded, Form Data)
   * @param contentType Request Body dataset type (JSON, HTML, JavaScript, Text, XML)
   */
  const enabledMergeViewForReqBody = async (
    newContent: string,
    requestDatasetType: RequestDatasetEnum,
    contentType: RequestDataTypeEnum,
  ) => {
    // Auto Navigation
    onUpdateRequestState({
      requestNavigation: RequestSectionEnum.REQUEST_BODY,
    });
    onUpdateRequestState({ requestBodyNavigation: requestDatasetType });
    onUpdateRequestState({ requestBodyLanguage: contentType });

    if (requestDatasetType === RequestDatasetEnum.RAW) {
      newModifiedContent = newContent;
    } else if (requestDatasetType === RequestDatasetEnum.URLENCODED) {
      newModifiedContent = convertJsonToKeyValPairs(JSON.parse(newContent));
    } else if (requestDatasetType === RequestDatasetEnum.FORMDATA) {
      newModifiedContent = convertJsonToKeyValPairs(JSON.parse(newContent));
    } else if (requestDatasetType === RequestDatasetEnum.BINARY) return;
    else return;
    await tick();

    if (isMergeViewEnableForRequestBody) {
      notifications.info("Please accept the current suggested changes first.");
      return;
    }

    mergeViewRequestDatasetType = requestDatasetType;
    isMergeViewEnableForRequestBody = true;
    // isMergeViewLoading = true;
  };

  const handleEventOnInsertSuggestion = (suggestion_type: string) => {
    captureEvent("copilot_suggestion_applied", {
      component: "RestExplorer",
      suggestion_type: suggestion_type,
    });
  };

  let isModeChangeModalOpen = false;
  let pendingMode = null;
  $: currentMode =
    $tab?.property?.request?.tests?.testCaseMode || TestCaseModeEnum.NO_CODE;

  /**
   * Check if there's existing data that would be lost when switching modes
   */
  const hasExistingData = (currentMode: TestCaseModeEnum) => {
    const tabTests = $tab?.property?.request?.tests;

    if (currentMode === TestCaseModeEnum.NO_CODE) {
      return (
        tabTests?.noCode &&
        tabTests.noCode.length > 0 &&
        tabTests.noCode.some(
          (test) =>
            test.name ||
            test.condition ||
            test.expectedResult ||
            test.testPath ||
            test.testTarget,
        )
      );
    } else if (currentMode === TestCaseModeEnum.SCRIPT) {
      return tabTests?.script && tabTests.script.trim().length > 0;
    }
    return false;
  };

  /**
   * Handle mode change with confirmation if needed
   */
  const handleModeChange = (newMode: TestCaseModeEnum) => {
    const currentTestMode =
      $tab?.property?.request?.tests?.testCaseMode || TestCaseModeEnum.NO_CODE;

    if (newMode === currentTestMode) return;

    // Check if there's existing data that would be lost
    if (hasExistingData(currentTestMode)) {
      pendingMode = newMode;
      isModeChangeModalOpen = true;
    } else {
      switchMode(newMode);
    }
  };

  /**
   * Actually perform the mode switch
   */
  const switchMode = (newMode: TestCaseModeEnum) => {
    onUpdateTests({
      ...$tab?.property?.request?.tests,
      testCaseMode: newMode,
    });
  }; /**
   * Confirm mode switch and proceed
   */
  const confirmModeSwitch = () => {
    if (pendingMode) {
      switchMode(pendingMode);
    }
    isModeChangeModalOpen = false;
    pendingMode = null;
  };

  /**
   * Cancel mode switch
   */
  const cancelModeSwitch = () => {
    isModeChangeModalOpen = false;
    pendingMode = null;
  };

  /**
   * Get the display name for the mode
   */
  const getModeDisplayName = (mode: TestCaseModeEnum) => {
    return mode === TestCaseModeEnum.NO_CODE ? "No Code" : "Script Mode";
  };

  /**
   * Embeds the changes suggested by AI in request data
   * @param target Where to insert the changes (Request Body or Headers or Parameters)
   * @param language Language type of suggested code changes by AI (JSON, HTML, JavaScript, Text, XML)
   * @param requestBodyType Request Body datas et type (Raw, Binary, URL Encoded, Form Data)
   * @param modifiedContent The new content suggested by AI
   */
  const handleApplyChangeOnAISuggestion = async (
    target: RequestSectionEnum,
    language: RequestDataTypeEnum,
    requestBodyType: RequestDatasetEnum,
    modifiedContent,
  ) => {
    // For testing, remove while raising PR
    // target = "Parameters";
    // target = "Headers";
    if (
      isMergeViewEnableForHeaders ||
      isMergeViewEnableForParams ||
      isMergeViewEnableForRequestBody
    ) {
      notifications.error("Please accept the current suggested changes first.");
      return;
    }
    handleEventOnInsertSuggestion(target);
    try {
      switch (target) {
        case RequestSectionEnum.REQUEST_BODY: {
          // For testing, remove while raising PR
          // requestBodyType = "URL Encoded" as RequestDatasetEnum;
          // requestBodyType = "Form Data" as RequestDatasetEnum;

          enabledMergeViewForReqBody(
            modifiedContent,
            requestBodyType,
            language,
          );
          break;
        }
        case RequestSectionEnum.HEADERS:
        case RequestSectionEnum.PARAMETERS: {
          const newData = convertJsonToKeyValPairs(JSON.parse(modifiedContent));

          // Auto navigating to request navigator tab
          onUpdateRequestState({
            requestNavigation:
              target === RequestSectionEnum.HEADERS
                ? RequestSectionEnum.HEADERS
                : RequestSectionEnum.PARAMETERS,
          });

          if (isMergeViewEnableForHeaders || isMergeViewEnableForParams) {
            notifications.error(
              "Please accept the current suggested changes first.",
            );
            return;
          }

          await sleep(500);
          newModifiedContent = newData;
          // isMergeViewLoading = true;
          if (target === RequestSectionEnum.HEADERS)
            isMergeViewEnableForHeaders = true;
          else isMergeViewEnableForParams = true;
          break;
        }
        default:
          break;
      }
    } catch (err) {
      console.log("Error which inserting AI suggestions: ", err);
    }
  };

  /**
   * Converts an object (data A) to an array of KeyValuePair objects (data B)
   * @param {Record<string, any>} dataA - The input object to convert
   * @param {boolean} defaultChecked - Default value for the checked property if not found in input (defaults to true)
   * @returns {KeyValuePair[]} Array of objects conforming to KeyValuePair interface
   */
  const convertJsonToKeyValPairs = (
    dataA: Record<string, any>,
  ): KeyValuePair[] => {
    // Check if input is valid
    if (!dataA || typeof dataA !== "object" || Array.isArray(dataA)) {
      throw new Error("Input must be a valid object");
    }

    const defaultChecked = true; // fallback value

    // Get checked value from input if it exists
    const checkedValue =
      typeof dataA.checked === "boolean" ? dataA.checked : defaultChecked;

    // Convert object to array of KeyValuePair objects
    const dataB: KeyValuePair[] = Object.entries(dataA)
      .filter(([key]) => key !== "checked") // Skip the checked property itself
      .map(([key, value]) => {
        // Convert value to string if it's not already
        const stringValue =
          Array.isArray(value) || (typeof value === "object" && value !== null)
            ? JSON.stringify(value)
            : String(value);

        return {
          key,
          value: stringValue,
          checked: checkedValue,
        };
      });

    return dataB;
  };

  // Utility function to create a delay
  const sleep = (ms: number): Promise<void> => {
    return new Promise((resolve) => setTimeout(resolve, ms));
  };

  const handleEventOnClickAI = (
    responseStatus: string | undefined,
    requestMethod: string | undefined,
  ) => {
    captureEvent("help_me_debug_cta_clicked", {
      component: "Rest Explorer",
      button_text: "Help me Bug",
      error_code: responseStatus,
      http_method: requestMethod,
    });
  };

  const handleOnClickAIDebug = async () => {
    const statusCode = storeData?.response?.status || "Unknown Error";
    const statusNumber = parseInt(statusCode.split(" ")[0]);
    const tag =
      statusNumber >= 500
        ? "DEBUG_5XX_ERROR_REQUEST"
        : "DEBUG_4XX_ERROR_REQUEST";

    handleEventOnClickAI(statusCode, tab.property?.request?.method);
    isAIDebugBtnEnable = false;

    // adjusting the panel layout
    if ($tabsSplitterDirection != "horizontal") {
      tabsSplitterDirection.set("horizontal");
      isChatbotOpenInCurrTab.set(true);
    }

    const isResponseGenerating =
      $tab?.property?.request?.state?.isChatbotGeneratingResponse;

    if (!isResponseGenerating) {
      onUpdateAiConversation([
        ...$tab?.property?.request?.ai?.conversations,
        {
          message: "Help me debug",
          messageId: "",
          type: "Sender",
          isLiked: false,
          isDisliked: false,
          status: true,
        },
      ]);

      // The prompt in the below format is required to trigger the 4xx error debugging instructions for AI model
      const debugPrompt = `[${tag}]
      I am getting the below mentioned error when I send request. 
      Can you help me debug this error and tell me what changes I need to make in my request to solve this issue.
      Error Response (${statusCode}): ${JSON.stringify(storeData?.response)}
      Please analyze this error and provide suggestions to fix it following your strict error debugging protocol.
      - If it's a 4xx error: I need **precise, formatted suggestions** that I can directly apply to my request configuration.
      - If it's a 5xx error: I need **server-side troubleshooting insights** and any client-side checks I can perform.
      [/${tag}]`;

      // ToDo: Enable scroller
      // Scroller for user prompt
      // setTimeout(() => {
      //   if (scrollList) scrollList("bottom", -1, "smooth");
      // }, 10);

      await onGenerateAiResponse(debugPrompt);

      // ToDo: Enable scroller
      // Scroller for AI response
      // setTimeout(() => {
      //   if (scrollList) scrollList("bottom", -1, "smooth");
      // }, 10);

      onUpdateRequestState({ isChatbotActive: true });
    }

    // ToDo: Register mixpanel event for "Help me debug" action
    // MixpanelEvent(Events.AI_Ext_Gen_Curl_Prompt);
  };

  /**
   * Checks whether the response status code indicates a client or server error (HTTP 4xx or 5xx).
   * @returns {boolean} - Returns true if the status code is between 400 and 599, otherwise false.
   */
  const isErrorStatus = () => {
    const status = storeData?.response?.status;
    const code = parseInt(status?.split(" ")[0]);
    return code >= 400 && code < 600;
  };

  const handleGenerateMockData = async () => {
    isGenerateMockDataModal = false;
    const response = await generateMockData();
    if (!response) {
      notifications.warning("Unable to Generate Mock Data.");
    }
  };

  const handleGenerateVariableShowDemoEvent = () => {
    captureEvent("generate_variables_detected", {
      event_source: `${isWebApp ? "web" : "desktop"}_app`,
    });
  };

  const handleGenerateVariableClickEvent = () => {
    captureEvent("generate_variables_discovered", {
      event_source: `${isWebApp ? "web" : "desktop"}_app`,
    });
  };

  $: {
    if ($tab?.property?.request?.isGeneratedVariable) {
      handleGenerateVariableShowDemoEvent();
    }
  }

  $: {
    if (storeData) {
      isAIDebugBtnEnable = isErrorStatus();
    }
  }
</script>

<!-- {#if $tab.tabId} -->
<div class="d-flex rest-explorer-layout h-100">
  <div class="w-100 d-flex flex-column h-100 p-3">
    <!-- Request Name Header -->
    <!-- 
        --
        -- Rest name header is set to display none 
        --
      -->
    <div class="d-flex justify-content-between w-100 p-3 d-none">
      <RequestName name={$tab.name} {onUpdateRequestName} />

      <div class="d-flex justify-content-between">
        <Button
          title="Save Request"
          type={"secondary"}
          loader={false}
          buttonClassProp="ms-2"
          buttonStartIcon={floppyDisk}
          onClick={async () => {
            const x = await onSaveRequest();
            if (
              x.status === "error" &&
              x.message ===
                "request is not a part of any workspace or collection"
            ) {
              isExposeSaveAsRequest = true;
            } else if (x.status === "success") {
              notifications.success("API request saved successfully.");
            }
          }}
        /> <span class="position-relative" style="width:35px;"> </span>
        <Button
          title="Share"
          type={"secondary"}
          buttonClassProp="ms-2"
          onClick={() => {}}
        />
      </div>
    </div>

    <!-- HTTP URL Section -->
    <div class="" id="request-tab-http-section">
      <HttpUrlSection
        class=""
        isSaveLoad={$loading}
        isSave={$tab.isSaved}
        bind:userRole
        requestUrl={$tab.property?.request?.url}
        httpMethod={$tab.property?.request?.method}
        isSendRequestInProgress={storeData?.isSendRequestInProgress}
        onSendButtonClicked={onSendRequest}
        onCancelButtonClicked={onCancelRequest}
        {onUpdateEnvironment}
        {environmentVariables}
        {onUpdateRequestUrl}
        {onUpdateRequestMethod}
        {toggleSaveRequest}
        {onSaveRequest}
        {isGuestUser}
      />
    </div>

    {#if isPopoverContainer && !($requestTabTestDemo || $requestTabTestScriptDemo)}
      <div class="pt-2"></div>
      <Popover onClose={closeCollectionHelpText} heading={`Welcome to Sparrow`}>
        <p class="mb-0 text-fs-12">
          Your one-stop solution for API testing and management. Start
          organizing your API requests into collections, utilize environment
          variables, and streamline your development process. Get started now by
          creating your first collection or exploring our features
          <span
            on:click={() => {
              isGuidePopup = true;
            }}
            class="link p-0 border-0"
            style="font-size: 12px;"
            >See how it works.
          </span>
        </p>
      </Popover>
      <div class="pt-2"></div>
    {/if}
    <div
      bind:this={splitpaneContainer}
      style="flex:1; overflow:auto; margin-top: 12px;"
    >
      <Motion
        animate={$tab?.property?.request?.state?.isChatbotActive
          ? chatbotOpenAnimation
          : chatbotClosedAnimation}
        transition={$tab?.property?.request?.state?.isChatbotActive
          ? chatbotOpenTransition
          : chatbotCloseTransition}
        let:motion
      >
        <Splitpanes class="explorer-chatbot-splitter">
          <Pane class="position-relative bg-transparent">
            <!--Disabling the Quick Help feature, will be taken up in next release-->

            {#if !isLoading}
              <Splitpanes
                class="rest-splitter w-100 h-100"
                id={"rest-splitter"}
                horizontal={$tabsSplitterDirection === "horizontal"
                  ? true
                  : false}
                dblClickSplitter={false}
                on:resize={(e) => {
                  onUpdateRequestState({
                    requestLeftSplitterWidthPercentage: e.detail[0].size,
                  });
                  onUpdateRequestState({
                    requestRightSplitterWidthPercentage: e.detail[1].size,
                  });
                }}
              >
                <Pane
                  minSize={30}
                  size={$requestTabTestScriptStep
                    ? 70
                    : $tab.property?.request?.state
                        ?.requestLeftSplitterWidthPercentage}
                  class="position-relative bg-transparent"
                >
                  <!-- Request Pane -->
                  <div
                    class="h-100 d-flex flex-column position-relative {$tabsSplitterDirection ===
                    'horizontal'
                      ? 'pb-1'
                      : 'pe-2'}"
                  >
                    <div class="hide-vertical-scroller" style="overflow:auto;">
                      <RequestNavigator
                        requestStateSection={$tab.property?.request?.state
                          ?.requestNavigation}
                        {onUpdateRequestState}
                        authParameterLength={$requestAuthParameter.value
                          ? 1
                          : 0}
                        authHeaderLength={$requestAuthHeader.value ? 1 : 0}
                        paramsLength={$tab.property?.request?.queryParams
                          ?.length || 0}
                        headersLength={$tab.property?.request?.headers
                          ?.length || 0}
                        autoGeneratedHeadersLength={$tab.property?.request
                          ?.autoGeneratedHeaders?.length || 0}
                        bind:isGenerateMockDataModal
                        {isGuestUser}
                        {userRole}
                        bulkEditHeadersActive={$tab?.property?.request.state
                          ?.isHeaderBulkEditActive}
                        bulkEditParamsActive={$tab?.property?.request.state
                          ?.isParameterBulkEditActive}
                      />
                    </div>
                    <div style="flex:1; overflow:auto;" class="p-0">
                      {#if $requestTabTestDemo && $tab.property?.request?.tests?.testCaseMode === "no-code"}
                        <RequestTests
                          tests={{
                            testCaseMode: "no-code",
                            noCode: [
                              {
                                id: "Test-1",
                                name: "Test-1",
                                condition: "",
                                expectedResult: "",
                                testPath: "",
                                testTarget: "",
                              },
                            ],
                            script: "",
                          }}
                          onTestsChange={() => {}}
                          tabSplitDirection={$tabsSplitterDirection}
                          testResults={[]}
                          responseBody={""}
                          responseHeader={[]}
                        />
                      {:else if $requestTabTestScriptDemo && $tab.property?.request?.tests?.testCaseMode === "script"}
                        <RequestTests
                          tests={{
                            testCaseMode: "script",
                            noCode: [
                              {
                                id: "Test-1",
                                name: "Test-1",
                                condition: "",
                                expectedResult: "",
                                testPath: "",
                                testTarget: "",
                              },
                            ],
                            script: `// What are the tests?\n// Tests are scripts that automatically check your API's response.\n// For example: Is the status code 200? Does the body contain an email field?\n// sp.test("Status code is 200", function () {\n//   sp.expect(sp.response.statusCode).to.equal(200);\n// });\n\n// You can:\n// - Use "Snippets" to insert common tests\n// - Or, write test cases manually using scripting or no code method`,
                          }}
                          onTestsChange={() => {}}
                          tabSplitDirection={$tabsSplitterDirection}
                          testResults={[]}
                          responseBody={""}
                          responseHeader={[]}
                        />
                      {:else if $tab.property?.request?.state?.requestNavigation === RequestSectionEnum.PARAMETERS}
                        <RequestParameters
                          isBulkEditActive={$tab?.property?.request.state
                            ?.isParameterBulkEditActive}
                          {onUpdateRequestState}
                          params={$tab.property?.request.queryParams}
                          {onUpdateRequestParams}
                          authParameter={$requestAuthParameter}
                          {onUpdateEnvironment}
                          {environmentVariables}
                          bind:isMergeViewEnabled={isMergeViewEnableForParams}
                          bind:isMergeViewLoading
                          bind:newModifiedContent
                        />
                      {:else if $tab.property?.request?.state?.requestNavigation === RequestSectionEnum.REQUEST_BODY}
                        <RequestBody
                          body={$tab.property?.request.body}
                          method={$tab.property?.request.method}
                          requestState={$tab.property?.request.state}
                          {onUpdateRequestBody}
                          {onUpdateRequestState}
                          {onUpdateEnvironment}
                          {environmentVariables}
                          {isWebApp}
                          bind:isMergeViewEnabled={isMergeViewEnableForRequestBody}
                          bind:isMergeViewLoading
                          bind:newModifiedContent
                          {mergeViewRequestDatasetType}
                        />
                      {:else if $tab.property?.request?.state?.requestNavigation === RequestSectionEnum.HEADERS}
                        <RequestHeaders
                          isBulkEditActive={$tab?.property?.request.state
                            ?.isHeaderBulkEditActive}
                          {onUpdateRequestState}
                          {environmentVariables}
                          {onUpdateEnvironment}
                          headers={$tab.property?.request.headers}
                          autoGeneratedHeaders={$tab.property?.request
                            .autoGeneratedHeaders}
                          authHeader={$requestAuthHeader}
                          onHeadersChange={onUpdateHeaders}
                          onAutoGeneratedHeadersChange={onUpdateAutoGeneratedHeaders}
                          {isWebApp}
                          bind:isMergeViewEnabled={isMergeViewEnableForHeaders}
                          bind:isMergeViewLoading
                          bind:newModifiedContent
                        />
                      {:else if $tab.property?.request?.state?.requestNavigation === RequestSectionEnum.AUTHORIZATION}
                        <RequestAuth
                          requestStateAuth={$tab.property?.request.state
                            .requestAuthNavigation}
                          requestStateAuthProfile={$tab.property.request.state
                            .selectedRequestAuthProfileId}
                          {onUpdateRequestState}
                          auth={$tab.property?.request.auth}
                          collectionAuth={$collectionAuth}
                          {onUpdateRequestAuth}
                          {onUpdateEnvironment}
                          {environmentVariables}
                          {collection}
                          {onOpenCollection}
                        />
                      {:else if $tab.property?.request?.state?.requestNavigation === RequestSectionEnum.TESTS}
                        <RequestTests
                          tests={$tab?.property?.request.tests}
                          onTestsChange={onUpdateTests}
                          tabSplitDirection={$tabsSplitterDirection}
                          testResults={storeData?.response?.testResults}
                          responseBody={storeData?.response?.body}
                          onShowModeChangeModal={handleModeChange}
                          responseHeader={storeData?.response?.headers}
                          {onGenerateTestCases}
                          isTestCasesGenerating={$isTestCasesGenerating}
                          {isGuestUser}
                          {userRole}
                        />
                      {:else if $tab.property?.request?.state?.requestNavigation === RequestSectionEnum.DOCUMENTATION}
                        <RequestDoc
                          isDocGenerating={$tab.property?.request?.state
                            ?.isDocGenerating}
                          isDocAlreadyGenerated={$tab.property?.request?.state
                            ?.isDocAlreadyGenerated}
                          {onGenerateDocumentation}
                          {onUpdateRequestDescription}
                          requestDoc={$tab.description}
                          {isGuestUser}
                          {userRole}
                        />
                      {/if}
                    </div>
                    {#if $requestTabTestDemo && $requestTabTestNoCodeStep === 1}
                      <RequestTabTourGuide
                        targetId={RequestTabTestsTourContent[0].targetId}
                        isVisible={true}
                        cardPosition={requestTabNocodeCardPosition(1)}
                      >
                        <TourGuideCard
                          titleName={RequestTabTestsTourContent[0].Title}
                          descriptionContent={RequestTabTestsTourContent[0]
                            .description}
                          cardNumber={1}
                          totalsCards={RequestTabTestsTourContent.length}
                          rightButtonName=""
                          onNext={handleNextStep}
                          onClose={handleCloseTour}
                          width={352}
                        />
                      </RequestTabTourGuide>
                    {/if}
                    {#if $requestTabTestDemo && $requestTabTestNoCodeStep === 4}
                      <RequestTabTourGuide
                        targetId={RequestTabTestsTourContent[3].targetId}
                        isVisible={true}
                        cardPosition={requestTabNocodeCardPosition(4)}
                      >
                        <TourGuideCard
                          titleName={RequestTabTestsTourContent[3].Title}
                          descriptionContent={RequestTabTestsTourContent[3]
                            .description}
                          cardNumber={4}
                          totalsCards={RequestTabTestsTourContent.length}
                          rightButtonName=""
                          onNext={handleNextStep}
                          onClose={handleCloseTour}
                          width={352}
                        />
                      </RequestTabTourGuide>
                    {/if}
                    {#if $requestTabTestScriptDemo && $requestTabTestScriptStep === 1}
                      <RequestTabTourGuide
                        targetId={RequestTabTestsScriptTourContent[0].targetId}
                        isVisible={true}
                        cardPosition={requestTabScriptCardPosition(1)}
                      >
                        <TourGuideCard
                          titleName={RequestTabTestsScriptTourContent[0].Title}
                          descriptionContent={RequestTabTestsScriptTourContent[0]
                            .description}
                          cardNumber={1}
                          totalsCards={RequestTabTestsScriptTourContent.length}
                          rightButtonName=""
                          onNext={handleNextStep}
                          onClose={handleCloseTour}
                          width={352}
                        />
                      </RequestTabTourGuide>
                    {/if}
                    {#if $requestTabTestScriptDemo && $requestTabTestScriptStep === 4}
                      <RequestTabTourGuide
                        targetId={RequestTabTestsScriptTourContent[3].targetId}
                        isVisible={true}
                        cardPosition={requestTabScriptCardPosition(4)}
                      >
                        <TourGuideCard
                          titleName={RequestTabTestsScriptTourContent[3].Title}
                          descriptionContent={RequestTabTestsScriptTourContent[3]
                            .description}
                          cardNumber={4}
                          totalsCards={RequestTabTestsScriptTourContent.length}
                          rightButtonName=""
                          onNext={handleNextStep}
                          onClose={handleCloseTour}
                          width={352}
                        />
                      </RequestTabTourGuide>
                    {/if}
                  </div>
                </Pane>
                <Pane
                  minSize={30}
                  size={$tab.property?.request?.state
                    ?.requestRightSplitterWidthPercentage}
                  class="bg-transparent position-relative"
                >
                  <!-- Response Pane -->
                  <div
                    class="d-flex flex-column h-100 {$tabsSplitterDirection ===
                    'horizontal'
                      ? 'pt-1'
                      : 'ps-2'}"
                    id="request-tab-response-section"
                  >
                    <div class="h-100 d-flex flex-column">
                      <div style="flex:1; overflow:auto; position:relative;">
                        {#if $requestTabTestDemo}
                          <ResponseDefaultScreen {isWebApp} />
                        {:else if storeData?.isSendRequestInProgress}
                          <ResponseDefaultScreen {isWebApp} />
                          <div
                            style="top: 0px; left: 0; right: 0; bottom: 0; z-index:3; position:absolute;"
                          >
                            <Loader loaderSize={"20px"} />
                          </div>
                        {:else if !storeData?.response.status}
                          <ResponseDefaultScreen {isWebApp} />
                        {:else if storeData?.response.status === ResponseStatusCode.ERROR}
                          <ResponseErrorScreen
                            onSendButtonClicked={onSendRequest}
                            response={storeData.response}
                            {environmentVariables}
                          />
                        {:else if storeData?.response.status}
                          <div
                            class="h-100 d-flex flex-column"
                            style="gap:12px"
                          >
                            <div
                              class="hide-vertical-scroller d-flex justify-content-between"
                              style=" z-index:1; background-color:var(--bg-ds-surface-900); overflow-y:auto;"
                            >
                              <ResponseNavigator
                                requestStateSection={storeData?.response
                                  .navigation}
                                {onUpdateResponseState}
                                responseHeadersLength={storeData?.response
                                  .headers?.length || 0}
                                responsePassedTestResultsLength={storeData?.response?.testResults?.filter(
                                  (test) => test.testStatus === true,
                                )?.length || 0}
                                responseTestResultsLength={storeData?.response
                                  ?.testResults?.length || 0}
                              />

                              <div class="d-flex">
                                {#if !isGuestUser && $policyConfig.enableAIAssistance && !isSharedWorkspace}
                                  <!-- AI debugging trigger button -->
                                  <!-- As chip component is not available,so using custom styleing to match, will replace it will chip component in later -->
                                  <div
                                    class="ms-5 d-flex ai-chip-button"
                                    class:enabled={isAIDebugBtnEnable}
                                    style="height: 32px; border: 1px solid {isAIDebugBtnEnable
                                      ? 'var(--border-ds-surface-100)'
                                      : 'var(--bg-secondary-550)'};  border-radius: 4px;  background-color: {isAIDebugBtnEnable
                                      ? 'var(--border-ds-surface-700)'
                                      : 'var(--border-ds-surface-500)'}"
                                  >
                                    <Button
                                      title="Help me debug"
                                      size={"small"}
                                      type={"teritiary-regular"}
                                      startIcon={SparkleFilled}
                                      disable={!isAIDebugBtnEnable}
                                      onClick={handleOnClickAIDebug}
                                    ></Button>
                                  </div>
                                {/if}

                                <ResponseStatus response={storeData.response} />
                              </div>
                            </div>
                            <div
                              class="d-flex flex-column"
                              style="flex:1; overflow:auto; min-height:0;"
                            >
                              {#if storeData?.response.navigation === ResponseSectionEnum.RESPONSE}
                                {#if storeData?.response.bodyLanguage !== "Image"}
                                  <ResponseBodyNavigator
                                    response={storeData?.response}
                                    apiState={storeData?.response}
                                    path={$tab.path}
                                    {onUpdateResponseState}
                                    {onClearResponse}
                                    {onSaveResponse}
                                    {isWebApp}
                                    {isGuestUser}
                                    {userRole}
                                  />
                                {/if}
                                <div
                                  style="flex:1; overflow:auto; border:1px solid var(--border-ds-surface-100); border-radius: 4px;"
                                >
                                  <ResponseBody
                                    response={storeData?.response}
                                    apiState={storeData?.response}
                                  />
                                </div>
                              {:else if storeData?.response.navigation === ResponseSectionEnum.HEADERS}
                                <div style="overflow:auto;">
                                  <ResponseHeaders
                                    responseHeader={storeData.response?.headers}
                                  />
                                </div>
                              {:else if storeData?.response.navigation === ResponseSectionEnum.TESTRESULT}
                                <!-- <div style="overflow:auto;"> -->
                                <ResponseTestResults
                                  responseTestResults={storeData.response
                                    ?.testResults}
                                  responseTestMessage={storeData.response
                                    ?.testMessage}
                                  tests={$tab?.property?.request.tests}
                                  {onFixTestScript}
                                  tabId={$tab?.tabId}
                                  {isGuestUser}
                                  {isSharedWorkspace}
                                  {userRole}
                                />
                                <!-- </div> -->
                              {/if}
                            </div>
                          </div>
                        {/if}
                        {#if $tab?.property?.request?.isGeneratedVariable && !$requestTabTestDemo && !$requestTabTestScriptDemo}
                          <div
                            style="position:absolute; bottom:12px; right:{!$tab
                              ?.property?.request?.state?.isChatbotActive
                              ? '56px'
                              : '0px'}; z-index:10;"
                          >
                            <RequestTourGuideCard
                              onAction={async () => {
                                handleGenerateVariableClickEvent();
                                await handleGenerateVariableDemo(
                                  $tab?.path?.collectionId ?? "",
                                  $tab?.path?.workspaceId ?? "",
                                );
                              }}
                              onClose={async () => {
                                await updateIsGeneratedVariable(false);
                                await InsertGenerateTrialFlow(
                                  $tab?.path?.collectionId ?? "",
                                );
                              }}
                            />
                          </div>
                        {/if}
                        {#if $tab.property?.request?.tests?.testCaseMode === "no-code" && $tab?.property?.request?.isRequestTestsNoCodeDemoCompleted && $tab.property?.request?.state?.requestNavigation === "Tests"}
                          <div
                            style="position:absolute; bottom:0px; right:{!$tab
                              ?.property?.request?.state?.isChatbotActive
                              ? '56px'
                              : '0px'}; z-index:10;"
                          >
                            <RequestTourGuideCard
                              title={"Make Your APIs Smarter!"}
                              message={"Writing tests ensures your APIs do exactly what you expect. With our no-code and script options, you can easily check responses, validate data, and catch issues early, without extra effort."}
                              onAction={() => {
                                onUpdateRequestState({
                                  isChatbotActive: false,
                                });
                                isChatbotOpenInCurrTab.set(false);
                                requestTabTestDemo.set(true);
                                isCloseRequestTestDemo(false);
                                onUpdateResponseState("Tests");
                                requestTabTestNoCodeStep.set(1);
                              }}
                              onClose={() => {
                                isCloseRequestTestDemo(false);
                                requestTabTestDemo.set(false);
                              }}
                            />
                          </div>
                        {/if}
                        {#if $tab.property?.request?.tests?.testCaseMode === "script" && $tab?.property?.request?.isRequestTestsScriptDemoCompleted && $tab.property?.request?.state?.requestNavigation === "Tests"}
                          <div
                            style="position:absolute; bottom:0px; right:{!$tab
                              ?.property?.request?.state?.isChatbotActive
                              ? '56px'
                              : '0px'}; z-index:10;"
                          >
                            <RequestTourGuideCard
                              title={"Make Your APIs Smarter!"}
                              message={"Writing tests ensures your APIs do exactly what you expect. With our no-code and script options, you can easily check responses, validate data, and catch issues early, without extra effort."}
                              onAction={() => {
                                onUpdateRequestState({
                                  isChatbotActive: false,
                                });
                                isChatbotOpenInCurrTab.set(false);
                                onUpdateResponseState("Tests");
                                isCloseRequestTestScriptDemo(false);
                                requestTabTestScriptDemo.set(true);
                                requestTabTestScriptStep.set(1);
                              }}
                              onClose={() => {
                                isCloseRequestTestScriptDemo(false);
                                requestTabTestScriptDemo.set(false);
                              }}
                            />
                          </div>
                        {/if}
                      </div>
                    </div>
                    {#if $requestTabTestDemo && $requestTabTestNoCodeStep === 2}
                      <RequestTabTourGuide
                        targetId={RequestTabTestsTourContent[1].targetId}
                        isVisible={true}
                        cardPosition={requestTabNocodeCardPosition(2)}
                      >
                        <TourGuideCard
                          titleName={RequestTabTestsTourContent[1].Title}
                          descriptionContent={RequestTabTestsTourContent[1]
                            .description}
                          cardNumber={2}
                          totalsCards={RequestTabTestsTourContent.length}
                          rightButtonName=""
                          onNext={handleNextStep}
                          onClose={handleCloseTour}
                          width={352}
                        />
                      </RequestTabTourGuide>
                    {/if}
                    {#if $requestTabTestDemo && $requestTabTestNoCodeStep === 5}
                      <RequestTabTourGuide
                        targetId={RequestTabTestsTourContent[4].targetId}
                        isVisible={true}
                        cardPosition={requestTabNocodeCardPosition(5)}
                      >
                        <TourGuideCard
                          titleName={RequestTabTestsTourContent[4].Title}
                          descriptionContent={RequestTabTestsTourContent[4]
                            .description}
                          cardNumber={5}
                          totalsCards={RequestTabTestsTourContent.length}
                          rightButtonName="Finish"
                          onNext={async () => {
                            handleNextStep();
                            await requestTabTestsDemoCompleted();
                          }}
                          onClose={handleCloseTour}
                          width={352}
                        />
                      </RequestTabTourGuide>
                    {/if}
                    {#if $requestTabTestScriptDemo && $requestTabTestScriptStep === 2}
                      <RequestTabTourGuide
                        targetId={RequestTabTestsScriptTourContent[1].targetId}
                        isVisible={true}
                        cardPosition={requestTabScriptCardPosition(2)}
                      >
                        <TourGuideCard
                          titleName={RequestTabTestsScriptTourContent[1].Title}
                          descriptionContent={RequestTabTestsScriptTourContent[1]
                            .description}
                          cardNumber={2}
                          totalsCards={RequestTabTestsScriptTourContent.length}
                          rightButtonName=""
                          onNext={handleNextStep}
                          onClose={handleCloseTour}
                          width={352}
                        />
                      </RequestTabTourGuide>
                    {/if}
                    {#if $requestTabTestScriptDemo && $requestTabTestScriptStep === 5}
                      <RequestTabTourGuide
                        targetId={RequestTabTestsScriptTourContent[4].targetId}
                        isVisible={true}
                        cardPosition={requestTabScriptCardPosition(5)}
                      >
                        <TourGuideCard
                          titleName={RequestTabTestsScriptTourContent[4].Title}
                          descriptionContent={RequestTabTestsScriptTourContent[4]
                            .description}
                          cardNumber={5}
                          totalsCards={RequestTabTestsScriptTourContent.length}
                          rightButtonName="Finish"
                          onNext={async () => {
                            handleCloseTour();
                            await requestTabTestScriptDemoCompleted();
                          }}
                          onClose={handleCloseTour}
                          width={352}
                        />
                      </RequestTabTourGuide>
                    {/if}
                  </div>
                </Pane>
              </Splitpanes>
            {:else}
              <!-- loading state -->
              <ResponseDefaultScreen isMainScreen={true} {isWebApp} />
            {/if}
          </Pane>
          <!-- AI Chatbot Interface -->
          {#if !isGuestUser && $tab?.property?.request?.state?.isChatbotActive && $policyConfig.enableAIAssistance && !isSharedWorkspace}
            <Pane
              class="position-relative bg-transparent"
              minSize={minSizePct}
              size={defaultSizePct}
              maxSize={maxSizePct}
            >
              <div use:motion class="h-100">
                {#if $tab?.property?.request?.state?.isChatbotActive}
                  <ChatBot
                    {tab}
                    {onUpdateAiPrompt}
                    {onUpdateAiConversation}
                    {onUpdateAiModel}
                    {onUpdateRequestState}
                    {onGenerateAiResponse}
                    {onStopGeneratingAIResponse}
                    {onToggleLike}
                    {handleApplyChangeOnAISuggestion}
                  />
                {/if}
              </div>
            </Pane>
          {/if}
        </Splitpanes>
      </Motion>
    </div>
  </div>
  <!--
      --
       -- Rest extension panel is set to display none 
      --
    -->
  <div class="d-none">
    <!-- <RestExtensionPanel
      state={$tab.property?.request?.state}
      requestMethod={$tab.property?.request?.method}
      requestUrl={$tab.property?.request?.url}
      requestName={$tab.name}
      requestDescription={$tab.description}
      requestPath={$tab.path}
      collections={$collections}
      {onSaveRequest}
      {readCollection}
      {readWorkspace}
      {onSaveAsRequest}
      {onCreateFolder}
      {onCreateCollection}
      {onUpdateRequestState}
      {onUpdateRequestDescription}
      {readRequestOrFolderInCollection}
    /> -->
  </div>
</div>

<Modal
  title={`Switching to ${getModeDisplayName(pendingMode)}`}
  type={"dark"}
  width={"40%"}
  zIndex={10000}
  isOpen={isModeChangeModalOpen}
  handleModalState={(flag = false) => {
    if (!flag) cancelModeSwitch();
  }}
>
  <div class="d-flex flex-column">
    <p
      class="mode-change-modal-text mb-3"
      style="padding-top: 20px; font-size:13px; padding-bottom:10px;"
    >
      {@html `The test cases you have created in ${getModeDisplayName(currentMode)} mode will not be carried over to  ${getModeDisplayName(pendingMode)}. If you switch, those test cases you have added will be lost. <br /> Do you still want to continue?`}
    </p>
    <div class="d-flex justify-content-end gap-2">
      <!-- Cancel button -->
      <Button
        title="Cancel"
        type="secondary"
        size="medium"
        onClick={cancelModeSwitch}
      />
      <!-- Confirm button -->
      <Button
        title={`Switch to ${getModeDisplayName(pendingMode)}`}
        type="primary"
        size="medium"
        onClick={confirmModeSwitch}
      />
    </div>
  </div>
</Modal>

<Modal
  title={"Save Request"}
  type={"dark"}
  width={"55%"}
  zIndex={10000}
  isOpen={isExposeSaveAsRequest}
  handleModalState={(flag = false) => {
    isExposeSaveAsRequest = flag;
  }}
>
  <SaveAsCollectionItem
    onClick={(flag = false) => {
      isExposeSaveAsRequest = flag;
    }}
    requestMethod={$tab.property?.request?.method}
    requestUrl={$tab.property?.request?.url}
    requestName={$tab.name}
    requestDescription={$tab.description}
    requestPath={$tab.path}
    collections={$collections}
    {readWorkspace}
    onSave={onSaveAsRequest}
    {onCreateFolder}
    {onCreateCollection}
    {onRenameCollection}
    {onRenameFolder}
  />
</Modal>
<!-- {/if} -->
<Modal
  title={"Replace Existing Data?"}
  type={"dark"}
  width={"40%"}
  zIndex={10000}
  isOpen={isGenerateMockDataModal}
  handleModalState={(flag = false) => {
    isGenerateMockDataModal = flag;
  }}
>
  <div class="d-flex flex-column">
    <p class="mock-data-modal-text">
      {`Generating a new set will remove the current dataset.`}
    </p>
    <div class="d-flex justify-content-end gap-2">
      <!-- Close button -->
      <Button
        title="Cancel"
        type="secondary"
        size="medium"
        onClick={() => (isGenerateMockDataModal = false)}
      />
      <!-- Proceed button -->
      <Button
        title="Continue"
        type="primary"
        size="medium"
        onClick={async () => {
          isMergeViewLoading = true;
          await handleGenerateMockData();
          isMergeViewLoading = false;
        }}
      />
    </div>
  </div>
</Modal>

<Modal
  title={""}
  type={"dark"}
  width={"474px"}
  zIndex={10000}
  isOpen={isGuidePopup}
  handleModalState={(flag = false) => {
    isGuidePopup = flag;
    isTourGuideOpen = false;
  }}
>
  <div style="position: relative;">
    <Carousel
      handleClosePopup={(flag = false) => {
        isGuidePopup = flag;
        isTourGuideOpen = false;
      }}
      data={[
        {
          id: 1,
          heading: "Creating a Collection: Import existing or Start a new one",
          subheading: `Organize your APIs efficiently within "Collections" for streamlined API management and testing. Click the + Add Collection button in the side panel to create a collection. Choose 'Import Collection' to bring in existing API collections or create an empty Collection. `,
          gif: `${azureBlobCDN}${CreateCollection}`,
        },
        {
          id: 2,
          heading: "Sending an API Request",
          subheading:
            "In the request builder, input your API endpoint URL in the URL field. Click the 'Send' button to dispatch the request. Instantly see the server's response, which includes status codes, response time, and data.",
          gif: `${azureBlobCDN}${SendingApiRequest}`,
        },
        {
          id: 3,
          heading: "Advanced API Request with Detailed Inputs",
          subheading:
            "Enter the endpoint URL in the URL field. Utilize 'Parameters' tab for parameters, 'Body' tab to input data payloads, 'Headers' tab for custom headers, and 'Auth' tab to manage access credentials. After filling in the required fields, click 'Send' to execute the request and view the detailed server response.",
          gif: `${azureBlobCDN}${AdvanceAPI}`,
        },
      ]}
    />
  </div>
</Modal>

<!-- ChatBot Toggler -->
{#if !isGuestUser && $policyConfig.enableAIAssistance}
  <div
    style="position: fixed;
        bottom: 28px;
        right:30px;
        z-index: 200;"
  >
    <div
      class="sparrow-ai-icon"
      role="button"
      on:click={() => {
        if ($tabsSplitterDirection != "horizontal") {
          tabsSplitterDirection.set("horizontal");
          isChatbotOpenInCurrTab.set(true);
        }
        onUpdateRequestState({
          isChatbotActive: !$tab?.property?.request?.state?.isChatbotActive,
        });

        MixpanelEvent(Events.AI_Chat_Initiation);
      }}
    >
      <div
        class="chatten-box"
        tabindex="0"
        style="display: {!$tab?.property?.request?.state?.isChatbotActive
          ? 'flex'
          : 'none'}"
      >
        <SparrowSecondaryIcon />
      </div>
    </div>
  </div>
{/if}

<style>
  .chatten-box {
    background-color: var(--bg-ds-primary-400);
    height: 40px;
    width: 40px;
    border-radius: 6px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .chatten-box:hover {
    background-color: var(--bg-ds-primary-500);
  }
  .chatten-box:focus-visible {
    height: 40px;
    width: 40px;
    border-radius: 10px;
    border: 2px solid var(--border-ds-primary-300);
    outline: none;
  }

  .rest-explorer-layout {
    background-color: var(--bg-ds-surface-900);
  }

  :global(.rest-splitter.splitpanes--vertical > .splitpanes__splitter) {
    width: 11px !important;
    height: 100% !important;
    background-color: var(--bg-secondary-500) !important;
    border-left: 5px solid var(--border-ds-surface-900) !important;
    border-right: 5px solid var(--border-ds-surface-900) !important;
    border-top: 0 !important;
    border-bottom: 0 !important;
  }
  :global(.rest-splitter.splitpanes--horizontal > .splitpanes__splitter) {
    height: 11px !important;
    width: 100% !important;
    background-color: var(--bg-ds-surface-100) !important;
    border-top: 5px solid var(--border-ds-surface-900) !important;
    border-bottom: 5px solid var(--border-ds-surface-900) !important;
    border-left: 0 !important;
    border-right: 0 !important;
  }
  :global(
    .rest-splitter > .splitpanes__splitter:active,
    .rest-splitter > .splitpanes__splitter:hover
  ) {
    background-color: var(--bg-ds-primary-400) !important;
  }

  /* Disabling the splitter for explorer and chatbot interface - only split dragger is allowed on hover */
  :global(
    .explorer-chatbot-splitter.splitpanes--vertical > .splitpanes__splitter
  ) {
    width: 8px !important;
    border: none !important;
    background: transparent !important;
  }

  :global(
    .explorer-chatbot-splitter.splitpanes--vertical
      > .splitpanes__splitter:hover,
    .explorer-chatbot-splitter.splitpanes--vertical
      > .splitpanes__splitter:active
  ) {
    border: none !important;
    border-right: 2px solid var(--border-ds-primary-300) !important;
    background: transparent !important;
  }

  .link {
    color: var(--text-primary-300);
    text-decoration: underline;
    cursor: pointer;
  }

  .ai-chip-button.enabled:hover {
    border-color: var(--border-ds-primary-400) !important;
    box-shadow: 0 0 4px 1px rgba(17, 173, 240, 0.4) !important;
  }
  .mock-data-modal-text {
    font-family: "Inter", sans-serif;
    font-weight: 400;
    font-style: normal;
    font-size: 14px;
    line-height: 1.43;
    letter-spacing: 0;
    vertical-align: middle;
    color: var(--text-ds-neutral-200);
  }
  .hide-vertical-scroller::-webkit-scrollbar {
    display: none; /* Chrome, Safari */
  }
</style>
