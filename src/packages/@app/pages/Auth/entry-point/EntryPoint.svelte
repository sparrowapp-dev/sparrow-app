<script lang="ts">
  import { notifications } from "@library/ui/toast/Toast";
  import sparrowicon from "@library/icons/logoSparrowSquare.svg";
  import Redirect from "../redirect/Redirect.svelte";
  import constants from "$lib/utils/constants";
  import Header from "$lib/components/header/Header.svelte";
  import star from "$lib/assets/star.svg";
  import copyToClipBoard from "$lib/utils/copyToClipboard";
  import { open } from "@tauri-apps/plugin-shell";
  import { version } from "../../../../../../src-tauri/tauri.conf.json";
  import externalLink from "$lib/assets/external_link.svg";
  import copyIcon from "$lib/assets/copy_icon.svg";
  import bg from "@library/icons/sparrowLogoBackground.svg";
  import BgContainer from "./BgContainer.svelte";
  let isEntry = false;

  let redirectRules = {
    title: "Opening Web Browser...",
    description: "",
    message: ``,
    isSpinner: true,
    buttonText: "Open Desktop App",
    buttonClick: () => {},
    loadingMessage: "Please wait while we sign you in....",
  };
  let externalSparrowLink = `${constants.SPARROW_AUTH_URL}`;
  const externalSparrowGithub = constants.SPARROW_GITHUB;
  const openDefaultBrowser = async () => {
    await open(externalSparrowLink);
  };
  const handleRedirect = (value) => {
    isEntry = value;
  };
</script>

{#if isEntry}
  <Redirect
    title={redirectRules.title}
    description={redirectRules.description}
    message={redirectRules.message}
    isSpinner={redirectRules.isSpinner}
    buttonText={redirectRules.buttonText}
    buttonClick={redirectRules.buttonClick}
    loadingMessage={redirectRules.loadingMessage}
    callback={handleRedirect}
  >
    <p class="sparrow-fs-16">
      If your browser doesnâ€™t open automatically, please visit
      <span
        on:click={openDefaultBrowser}
        class="text-primary-150 cursor-pointer text-decoration-underline"
        >Sparrow website <img class="mx-2" src={externalLink} alt="" /></span
      >
      to sign In or copy URL
      <span
        class="text-labelColor cursor-pointer text-decoration-underline bg-secondary-550"
        style="border-radius: 2px;"
        on:click={async () => {
          await copyToClipBoard(externalSparrowLink);
          notifications.success("Link copied to clipboard!");
        }}><img src={copyIcon} class="px-2" />Copy</span
      >
    </p></Redirect
  >
{:else}
  <BgContainer>
    <div
      class="text-white d-flex justify-content-center align-items-center bg-primary-300"
      style="height: 60px; width: 60px; border-radius: 6px;"
    >
      <img src={sparrowicon} alt="" class="" />
    </div>
    <p
      class="container-header pt-4 pb-4 sparrow-fs-28 sparrow-fw-600 text-whiteColor text-center ms-2 me-2"
      style="font-weight: 500;"
    >
      Welcome to <span class="text-primary-300">Sparrow!</span>
    </p>
    <!-- <p class="card-subtitle sparrow-fs-20 mb-3 text-center">
      Create an account or sign In
    </p> -->
    <div class="mb-1">
      <button
        class="btn btn-primary mb-3 w-100 text-whiteColor border-0"
        on:click={() => {
          handleRedirect(true);
          openDefaultBrowser();
        }}
      >
        Create Account or Sign In</button
      >
    </div>
    <div class="w-100 mb-3 d-flex align-items-center justify-content-center">
      <a
        href={`mailto:${constants.SPARROW_SUPPORT_EMAIL}`}
        class="px-2 sparrow-fs-12 text-secondary-250">Need Help?</a
      >
      <span class="px-2 text-secondary-250 fw-bold mb-1">|</span>
      <a
        href={`mailto:${constants.SPARROW_SUPPORT_EMAIL}`}
        class="px-2 sparrow-fs-12 text-secondary-250">Report Issue</a
      >
    </div>
    <div slot="outside">
      <p
        class="text-center sparrow-fs-16 d-flex cursor-pointer mt-5 d-flex justify-content-center align-items-center mb-5"
        on:click={async () => {
          await open(externalSparrowGithub);
        }}
      >
        <img src={star} class="me-2" alt="" />
        <span>Star us on GitHub</span>
      </p>
      <div class="divider-line my-4" />
      <p class="text-center text-secondary-250 sparrow-fs-14">
        Version {version}
      </p>
      <p class="check-for-update text-center sparrow-fs-12">Check for Update</p>
    </div>
  </BgContainer>
{/if}

<div
  style="height: 100vh; top:0; left:0;
        right:0; z-index:-100 !important"
  class="w-100 position-fixed bg-blackColor"
>
  <img src={bg} alt="" style="height:100%; width:100%;" />
</div>

<style>
  .btn-primary {
    background: var(--bg-primary-300);
  }
  a {
    text-decoration: none;
  }
  .cursor-pointer {
    cursor: pointer;
  }
  .divider-line {
    height: 2px;
    width: 80vw;
    margin: 0 auto;
    background: linear-gradient(
      90deg,
      var(--bg-secondary-900) 0%,
      #354366 51.5%,
      var(--bg-secondary-900) 100%
    );
  }

  .check-for-update {
    background: linear-gradient(
      90deg,
      var(--bg-primary-250) 0%,
      var(--bg-primary-300) 100%
    );
    background-clip: text;
    color: transparent;
  }
</style>
