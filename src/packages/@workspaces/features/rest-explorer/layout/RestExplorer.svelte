<script lang="ts">
  // ---- Assets
  import floppyDisk from "$lib/assets/floppy-disk.svg";
  import angleDown from "$lib/assets/angle-down.svg";
  import SplitterButton from "../assets/icons/SplitterButton.svelte";

  // ---- Components
  import {
    HttpUrlSection,
    RequestHeaders,
    RequestNavigator,
    ResponseNavigator,
    RequestAuth,
    ResponseDefaultScreen,
    ResponseErrorScreen,
    ResponseHeaders,
    ResponseBodyNavigator,
    RequestBody,
    RequestName,
    ResponseBody,
    RestExtensionPanel,
    RequestParameters,
    ResponseStatus,
  } from "@workspaces/features/rest-explorer/components";
  import Loader from "$lib/components/Transition/loader/Loader.svelte";
  import { ModalWrapperV1 } from "$lib/components";
  import Dropdown from "$lib/components/dropdown/Dropdown.svelte";
  import { notifications } from "$lib/components/toast-notification/ToastNotification";
  import { Splitpanes, Pane } from "svelte-splitpanes";
  import Button from "$lib/components/buttons/Button.svelte";

  import type { CollectionDocument } from "$lib/database/app.database";
  import type { Observable } from "rxjs";
  import { SaveAsRequest } from "@workspaces/features";
  import type {
    ClearResponseType,
    CreateCollectionType,
    CreateFolderType,
    ReadCollectionType,
    ReadRequestOrFolderInCollectionType,
    ReadWorkspaceType,
    SaveAsRequestType,
    SaveRequestType,
    SendRequestType,
    UpdateAutoGeneratedHeadersType,
    UpdateHeadersType,
    UpdateParamsType,
    UpdateRequestAuthType,
    UpdateRequestBodyType,
    UpdateRequestDescriptionType,
    UpdateRequestMethodType,
    UpdateRequestNameType,
    UpdateRequestStateType,
    UpdateRequestUrlType,
  } from "@workspaces/common/type";
  import {
    RequestSectionEnum,
    ResponseSectionEnum,
    type KeyValue,
    type RequestTab,
  } from "@common/types/rest-explorer";
  import { restSplitterDirection } from "../store";

  export let tab: Observable<RequestTab>;
  export let collections: Observable<CollectionDocument[]>;
  export let requestAuthHeader: Observable<KeyValue>;
  export let requestAuthParameter: Observable<KeyValue>;
  export let onUpdateRequestUrl: UpdateRequestUrlType;
  export let onSendRequest: SendRequestType;
  export let onUpdateRequestMethod: UpdateRequestMethodType;
  export let onUpdateRequestParams: UpdateParamsType;
  export let onUpdateRequestName: UpdateRequestNameType;
  export let onUpdateRequestBody: UpdateRequestBodyType;
  export let onUpdateRequestAuth: UpdateRequestAuthType;
  export let onUpdateHeaders: UpdateHeadersType;
  export let onUpdateAutoGeneratedHeaders: UpdateAutoGeneratedHeadersType;
  export let onUpdateRequestState: UpdateRequestStateType;
  export let onClearResponse: ClearResponseType;
  export let onSaveRequest: SaveRequestType;
  export let onUpdateRequestDescription: UpdateRequestDescriptionType;
  export let readRequestOrFolderInCollection: ReadRequestOrFolderInCollectionType;
  export let readCollection: ReadCollectionType;
  export let readWorkspace: ReadWorkspaceType;
  export let onSaveAsRequest: SaveAsRequestType;
  export let onCreateFolder: CreateFolderType;
  export let onCreateCollection: CreateCollectionType;

  let isExposeSaveAsRequest = false;
  const toggleSaveRequest = (flag: boolean): void => {
    isExposeSaveAsRequest = flag;
  };

  /**
   * @description - sets styling to the splitpanes splitter (divider that shifts split panes)
   */
  const stylePanes = () => {
    const splitter: HTMLElement | null = document.querySelector(
      ".splitter-request .splitpanes__splitter",
    );
    if (splitter && $restSplitterDirection === "horizontal") {
      // horizontal view
      splitter.style.height = "2px";
      splitter.style.width = "100%";
    } else if (splitter) {
      // vertical view
      splitter.style.height = "100%";
      splitter.style.width = "2px";
    }
  };

  /**
   * @description - re-calculates value when dependency changes
   */
  $: {
    if ($restSplitterDirection) {
      stylePanes();
    }
  }
</script>

{#if $tab.tabId}
  <div class="d-flex rest-explorer-layout">
    <div class="w-100 d-flex flex-column h-100 p-3">
      <!-- Request Name Header -->
      <!-- 
        --
        -- Rest name header is set to display none 
        --
      -->
      <div class="d-flex justify-content-between w-100 p-3 d-none">
        <RequestName name={$tab.name} {onUpdateRequestName} />

        <div class="d-flex justify-content-between">
          <Button
            title="Save Request"
            type="dark"
            loader={false}
            buttonClassProp="ms-2"
            buttonStartIcon={floppyDisk}
            onClick={async () => {
              const x = await onSaveRequest();
              if (
                x.status === "error" &&
                x.message ===
                  "request is not a part of any workspace or collection"
              ) {
                isExposeSaveAsRequest = true;
              } else if (x.status === "success") {
                notifications.success("API request saved");
              }
            }}
          />

          <span class="position-relative" style="width:35px;">
            <Dropdown
              disabled={false}
              dropdownId={"saveAsDropdown"}
              dropDownType={{ type: "img", title: angleDown }}
              data={[
                {
                  name: "Save As",
                  id: "collection",
                  dynamicClasses: "text-whiteColor",
                },
              ]}
              onclick={() => {
                isExposeSaveAsRequest = true;
              }}
              staticCustomStyles={[
                {
                  id: "saveAsDropdown-options-container",
                  styleKey: "minWidth",
                  styleValue: "180px",
                },
              ]}
              staticClasses={[
                {
                  id: "saveAsDropdown-img",
                  classToAdd: ["btn", "bg-dullBackground", "px-2", "py-1"],
                },
                {
                  id: "saveAsDropdown-options-name",
                  classToAdd: ["fs-6"],
                },
                {
                  id: "saveAsDropdown-options-container",
                  classToAdd: ["end-0", "mt-1", "rounded"],
                },
              ]}
            ></Dropdown>
          </span>
          <Button
            title="Share"
            type="dark"
            buttonClassProp="ms-2"
            onClick={() => {}}
          />
        </div>
      </div>

      <!-- HTTP URL Section -->
      <HttpUrlSection
        class=""
        requestUrl={$tab.property.request.url}
        httpMethod={$tab.property.request.method}
        splitterDirection={$tab.property.request?.state
          ?.requestSplitterDirection}
        isSendRequestInProgress={$tab.property.request?.state
          ?.isSendRequestInProgress}
        onSendButtonClicked={onSendRequest}
        {onUpdateRequestUrl}
        {onUpdateRequestMethod}
        {onUpdateRequestState}
        {toggleSaveRequest}
        {onSaveRequest}
      />

      <Splitpanes
        class="splitter-request"
        id={"rest-splitter"}
        style="height: calc(100vh - 160px); margin-top:10px;"
        on:ready={stylePanes}
        horizontal={$restSplitterDirection === "horizontal" ? true : false}
        dblClickSplitter={false}
        on:resize={(e) => {
          onUpdateRequestState({
            requestLeftSplitterWidthPercentage: e.detail[0].size,
          });
          onUpdateRequestState({
            requestRightSplitterWidthPercentage: e.detail[1].size,
          });
        }}
      >
        <Pane
          minSize={30}
          size={$tab.property.request?.state
            ?.requestLeftSplitterWidthPercentage}
          class="position-relative pb-3"
        >
          <!-- Request Pane -->
          <div class="h-100 position-relative">
            <RequestNavigator
              requestStateSection={$tab.property.request?.state
                ?.requestNavigation}
              {onUpdateRequestState}
              authParameterLength={$requestAuthParameter.value ? 1 : 0}
              authHeaderLength={$requestAuthHeader.value ? 1 : 0}
              paramsLength={$tab.property?.request?.queryParams?.length || 0}
              headersLength={$tab.property?.request?.headers?.length || 0}
              autoGeneratedHeadersLength={$tab.property?.request
                ?.autoGeneratedHeaders?.length || 0}
            />
            {#if $tab.property.request?.state?.requestNavigation === RequestSectionEnum.PARAMETERS}
              <RequestParameters
                params={$tab.property.request.queryParams}
                {onUpdateRequestParams}
                authParameter={$requestAuthParameter}
              />
            {:else if $tab.property.request?.state?.requestNavigation === RequestSectionEnum.REQUEST_BODY}
              <RequestBody
                body={$tab.property.request.body}
                method={$tab.property.request.method}
                requestState={$tab.property.request.state}
                {onUpdateRequestBody}
                {onUpdateRequestState}
              />
            {:else if $tab.property.request?.state?.requestNavigation === RequestSectionEnum.HEADERS}
              <RequestHeaders
                headers={$tab.property.request.headers}
                autoGeneratedHeaders={$tab.property.request
                  .autoGeneratedHeaders}
                authHeader={$requestAuthHeader}
                onHeadersChange={onUpdateHeaders}
                onAutoGeneratedHeadersChange={onUpdateAutoGeneratedHeaders}
              />
            {:else if $tab.property.request?.state?.requestNavigation === RequestSectionEnum.AUTHORIZATION}
              <RequestAuth
                requestStateAuth={$tab.property.request.state
                  .requestAuthNavigation}
                {onUpdateRequestState}
                auth={$tab.property.request.auth}
                {onUpdateRequestAuth}
              />
            {/if}
          </div>
        </Pane>
        <Pane
          minSize={30}
          size={$tab.property.request?.state
            ?.requestRightSplitterWidthPercentage}
          class="position-relative pt-3 "
        >
          <!-- Response Pane -->
          <div class="d-flex flex-column h-100">
            {#if $tab.property.request?.state?.isSendRequestInProgress}
              <ResponseDefaultScreen />
              <div
                style="top: 10px; left: 0; right: 0; bottom: 0; z-index:3; position:absolute;"
              >
                <Loader loaderSize={"80px"} />
              </div>
            {:else if !$tab.property.request?.response?.status}
              <ResponseDefaultScreen />
            {:else if $tab.property.request?.response?.status === "Not Found"}
              <ResponseErrorScreen />
            {:else if $tab.property.request?.response?.status}
              <ResponseStatus response={$tab.property.request.response} />
              <ResponseNavigator
                requestStateSection={$tab.property.request.state
                  ?.responseNavigation}
                {onUpdateRequestState}
                responseHeadersLength={$tab.property?.request?.response?.headers
                  ?.length || 0}
              />
              {#if $tab.property.request.state?.responseNavigation === ResponseSectionEnum.RESPONSE}
                {#if $tab.property.request.state?.responseBodyLanguage !== "Image"}
                  <ResponseBodyNavigator
                    response={$tab.property.request.response}
                    apiState={$tab.property.request.state}
                    {onUpdateRequestState}
                    {onClearResponse}
                  />
                {/if}
                <ResponseBody
                  response={$tab.property.request.response}
                  apiState={$tab.property.request.state}
                />
              {:else if $tab.property.request.state?.responseNavigation === ResponseSectionEnum.HEADERS}
                <ResponseHeaders
                  responseHeader={$tab.property.request.response.headers}
                />
              {/if}
            {/if}
          </div></Pane
        >
      </Splitpanes>
    </div>
    <!--
      --
       -- Rest extension panel is set to display none 
      --
    -->
    <div class="d-none">
      <RestExtensionPanel
        state={$tab.property.request?.state}
        requestMethod={$tab.property.request?.method}
        requestUrl={$tab.property.request?.url}
        requestName={$tab.name}
        requestDescription={$tab.description}
        requestPath={$tab.path}
        collections={$collections}
        {onSaveRequest}
        {readCollection}
        {readWorkspace}
        {onSaveAsRequest}
        {onCreateFolder}
        {onCreateCollection}
        {onUpdateRequestState}
        {onUpdateRequestDescription}
        {readRequestOrFolderInCollection}
      />
    </div>
  </div>
  <ModalWrapperV1
    title={"Save Request"}
    type={"dark"}
    width={"55%"}
    zIndex={10000}
    isOpen={isExposeSaveAsRequest}
    handleModalState={(flag = false) => {
      isExposeSaveAsRequest = flag;
    }}
  >
    <SaveAsRequest
      onClick={(flag = false) => {
        isExposeSaveAsRequest = flag;
      }}
      requestMethod={$tab.property.request?.method}
      requestUrl={$tab.property.request?.url}
      requestName={$tab.name}
      requestDescription={$tab.description}
      requestPath={$tab.path}
      collections={$collections}
      {readWorkspace}
      {onSaveAsRequest}
      {onCreateFolder}
      {onCreateCollection}
    />
  </ModalWrapperV1>
{/if}

<style>
  .rest-explorer-layout {
    background-color: var(--bg-primary-800);
  }
  :global(.rest-explorer-layout .splitpanes.default-theme .splitpanes__pane) {
    background-color: var(--bg-primary-800) !important;
  }

  :global(.splitter_custom) {
    background-color: var(--dropdown-button) !important;
  }
</style>
